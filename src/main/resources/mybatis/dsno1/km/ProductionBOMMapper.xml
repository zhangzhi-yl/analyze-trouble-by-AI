<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.km.ProductionBOMMapper">
	
	<!--表名 -->
	<sql id="tableName">
		KM_ProductionBOM
	</sql>
	
	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		f.BOM_Num,	
		f.FMNum,	
		f.SpecificationsDesc,	
		f.FCount,	
		f.FUnit,	
		f.FVersion,	
		f.TermOfValidity,	
		f.BOMVersion,	
		f.ComponentAllocation,	
		f.ProcessRouteRel,	
		f.FExplanation,	
		f.FCreatePersonID,	
		f.FCreateTime,	
		f.FStatus,	
		f.ProductionBOM_ID,
		f.FMatId
	</sql>
	
	<!-- 字段用于新增 -->
	<sql id="Field2">
		BOM_Num,	
		FMNum,	
		SpecificationsDesc,	
		FCount,	
		FUnit,	
		FVersion,	
		TermOfValidity,	
		BOMVersion,	
		ComponentAllocation,	
		ProcessRouteRel,	
		FExplanation,	
		FCreatePersonID,	
		FCreateTime,	
		FStatus,	
		ProductionBOM_ID,
		FMatId
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{BOM_Num},	
		#{FMNum},	
		#{SpecificationsDesc},	
		#{FCount},	
		#{FUnit},	
		#{FVersion},	
		#{TermOfValidity},	
		#{BOMVersion},	
		#{ComponentAllocation},	
		#{ProcessRouteRel},	
		#{FExplanation},	
		#{FCreatePersonID},	
		#{FCreateTime},	
		#{FStatus},	
		#{ProductionBOM_ID},
		#{FMatId}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field2"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			ProductionBOM_ID = #{ProductionBOM_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			BOM_Num = #{BOM_Num},
			SpecificationsDesc = #{SpecificationsDesc},
			FCount = #{FCount},
			FVersion = #{FVersion},
			TermOfValidity = #{TermOfValidity},
			BOMVersion = #{BOMVersion},
			ComponentAllocation = #{ComponentAllocation},
			ProcessRouteRel = #{ProcessRouteRel},
			FExplanation = #{FExplanation},
			FMatId=#{FMatId}
		where 
			ProductionBOM_ID = #{ProductionBOM_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		<include refid="Field"></include>,f1.MAT_NAME,f1.MAT_CODE,f2.FName Route_Name,f2.FNum Route_Num,
		isnull(f1.MAT_CODE,'无编号')+'/'+isnull(f1.MAT_NAME,'无名称')  FMatJoint,f3.FNAME FUnitName
		from 
		<include refid="tableName"></include> f
		left join MBASE_MAT_BASIC f1
		on f.FMatId=f1.MAT_BASIC_ID
		left join KM_ProcessRoute f2
		on f.ProcessRouteRel=f2.ProcessRoute_ID
		left join MBASE_UNIT_INFO f3
		on f1.MAT_MAIN_UNIT=f3.UNIT_INFO_ID
		where 
			f.ProductionBOM_ID = #{ProductionBOM_ID}
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>,f1.MAT_NAME,f1.MAT_CODE,f2.FName Route_Name,f2.FNum Route_Num,
		isnull(f1.MAT_CODE,'无编号')+'/'+isnull(f1.MAT_NAME,'无名称')  FMatJoint,f3.FNAME FUnitName
		from 
		<include refid="tableName"></include> f
		left join MBASE_MAT_BASIC f1
		on f.FMatId=f1.MAT_BASIC_ID
		left join KM_ProcessRoute f2
		on f.ProcessRouteRel=f2.ProcessRoute_ID
		left join MBASE_UNIT_INFO f3
		on f1.MAT_MAIN_UNIT=f3.UNIT_INFO_ID
		where 1=1
		<if test="pd.KEYWORDS_MATCODE != null and pd.KEYWORDS_MATCODE != ''">
			and
				(
					f1.MAT_CODE LIKE '%'+ #{pd.KEYWORDS_MATCODE}+'%'
				)
		</if>
		<if test="pd.KEYWORDS_MATNAME != null and pd.KEYWORDS_MATNAME != ''">
			and
				(
					f1.MAT_NAME LIKE '%'+ #{pd.KEYWORDS_MATNAME}+'%'
				)
		</if>
		<if test="pd.KEYWORDS_FVersion != null and pd.KEYWORDS_FVersion != ''">
			and
				(
					f.FVersion =#{pd.KEYWORDS_FVersion}
				)
		</if>
		[fhstart] order by FCreateTime desc[fhend]
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			ProductionBOM_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	<!-- 获取BOM列表-可搜索-前100条 -->
	<select id="getBOMList" parameterType="pd" resultType="pd">
		select
		top 100 ProductionBOM_ID,MAT_BASIC_ID,MAT_NAME,MAT_CODE,isnull(MAT_NAME,'无名称')+'/'+isnull(MAT_CODE,'无编号')+'/V'+isnull(FVersion,'无版本')  FSelectOption
		from 
		<include refid="tableName"></include> f
		left join MBASE_MAT_BASIC h
		on h.MAT_BASIC_ID=f.FMatId
		where 1=1
		and FStatus='已发布'
		<if test="OUT_MAT != null and OUT_MAT != ''"><!-- 产出物料检索 -->
			and 
			MAT_CODE=#{OUT_MAT}
		</if>
		<if test="KEYWORDS != null and KEYWORDS != ''"><!-- 关键词检索 -->
			and 
			(
			MAT_NAME LIKE '%'+ #{KEYWORDS}+'%'
			or
			MAT_CODE LIKE '%'+ #{KEYWORDS}+'%'
			)	
		</if>
		 order by h.MAT_CODE 
		
	</select>
	
	<!-- 单号验重 -->
	<select id="getRepeatNum" parameterType="pd" resultType="pd">
		select
		isnull(count(*),0) RepeatNum
		from 
		<include refid="tableName"></include> f
		where 1=1
		and BOM_Num=#{BOM_Num}
		<if test="ProductionBOM_ID != null and ProductionBOM_ID != ''">
			and f.ProductionBOM_ID != #{ProductionBOM_ID}
		</if>
	</select>
	
		<!-- 发布/停用 -->
	<update id="release" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			FStatus = #{FStatus}
		where 
			ProductionBOM_ID = #{ProductionBOM_ID}
	</update>
	<!-- yy356703572qq(彬耶) -->
</mapper>