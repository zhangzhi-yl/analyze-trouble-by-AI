<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.pp.PurchasDetailsMapper">
	
	<!--表名 -->
	<sql id="tableName">
		PP_PurchasDetails
	</sql>
	
	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		f.RowClose,	
		f.PurchaseApplyID,	
		f.MaterialID,	
		f.SProp,	
		f.SPropKey,	
		f.FCount,	
		f.SpecificationsDesc,	
		f.FUnit,	
		f.PurchaseApplyKey,	
		f.PurchaseApplyUnit,	
		f.SuggestedPurchasingTime,	
		f.PurchaseLeadTime,	
		f.DemandTime,	
		f.FPurchaser,	
		f.OccupationOfInventory,	
		f.UnitPrice,	
		f.FExplanation,	
		f.PurchasDetails_ID,
		f.RowNum,
		f.FPushCount,
		
		f.FigureNum,
		f.StandardNum,
		f.FWorkblank,
		f.FSupplier,
		f.FType,
		f.FIsPush
		
	</sql>
	
	<!-- 字段用于新增 -->
	<sql id="Field2">
		RowClose,	
		PurchaseApplyID,	
		MaterialID,	
		SProp,	
		SPropKey,	
		FCount,	
		SpecificationsDesc,	
		FUnit,	
		PurchaseApplyKey,	
		PurchaseApplyUnit,	
		SuggestedPurchasingTime,	
		PurchaseLeadTime,	
		DemandTime,	
		FPurchaser,	
		OccupationOfInventory,	
		UnitPrice,	
		FExplanation,	
		PurchasDetails_ID,
		RowNum,
		FPushCount,
		
		FigureNum,
		StandardNum,
		FWorkblank,
		FSupplier,
		FType,
		FIsPush
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{RowClose},	
		#{PurchaseApplyID},	
		#{MaterialID},	
		#{SProp},	
		#{SPropKey},	
		#{FCount},	
		#{SpecificationsDesc},	
		#{FUnit},	
		#{PurchaseApplyKey},	
		#{PurchaseApplyUnit},	
		#{SuggestedPurchasingTime},	
		#{PurchaseLeadTime},	
		#{DemandTime},	
		#{FPurchaser},	
		#{OccupationOfInventory},	
		#{UnitPrice},	
		#{FExplanation},	
		#{PurchasDetails_ID},
		#{RowNum},
		#{FPushCount},
		
		#{FigureNum},
		#{StandardNum},
		#{FWorkblank},
		#{FSupplier},
		#{FType},
		#{FIsPush}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field2"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			PurchasDetails_ID = #{PurchasDetails_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			MaterialID = #{MaterialID},
			SPropKey = #{SPropKey},
			FCount = #{FCount},
			SpecificationsDesc = #{SpecificationsDesc},
			FUnit = #{FUnit},
			PurchaseApplyKey = #{PurchaseApplyKey},
			SuggestedPurchasingTime = #{SuggestedPurchasingTime},
			PurchaseLeadTime = #{PurchaseLeadTime},
			DemandTime = #{DemandTime},
			FPurchaser = #{FPurchaser},
			OccupationOfInventory = #{OccupationOfInventory},
			UnitPrice = #{UnitPrice},
			FExplanation = #{FExplanation},
			
			FigureNum = #{FigureNum},
			StandardNum = #{StandardNum},
			FWorkblank = #{FWorkblank},
			FSupplier = #{FSupplier},
			FType = #{FType},
			PurchasDetails_ID = PurchasDetails_ID
		where 
			PurchasDetails_ID = #{PurchasDetails_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		<include refid="Field"></include>,f1.SalesOrder_ID,f1.MaterialID AS OrderMaterialID,f1.PlanningWorkOrder_ID
		from 
		<include refid="tableName"></include> f
		LEFT JOIN PP_PurchaseApply f1
        ON f.PurchaseApplyID=f1.PurchaseApply_ID
		where 
			f.PurchasDetails_ID = #{PurchasDetails_ID}
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		f.PurchaseApply_ID,	
		f.FCustomer,	
		f.RelationNum,	
		f.BusinessType,	
		f.DataSources,	
		f.FNum,	
		f.FOrderer,	
		f.FExplanation FExplanationMain,	
		f.ApplyPerson,	
		f.FMakeBillsPersoID,	
		f.FMakeBillsTime,	
		f.FCheckPersonID,	
		f.FCheckTime,	
		f.FCheckFlag,
		isnull(f2.FName,'无名称')  +'/'+isnull(f2.FNum,'无编号')  FCustomerJoint,
		f3.NAME FOrdererName,
		f4.NAME ApplyPersonName,
		f5.NAME FMakeBillsPersoIDName,
		f6.NAME FCheckPersonIDName,
		f10.NAME FPurchaserName,
		f1.*,
		f8.FNAME FUnitName,
		f7.MAT_CODE,f7.MAT_NAME,
		isnull(f7.MAT_CODE,'无编号')+'/'+isnull(f7.MAT_NAME,'无名称') FMatJoint,
		f7.MAT_AUXILIARY_ID,
		f9.MAT_AUXILIARYMX_NAME,f9.MAT_AUXILIARYMX_CODE,
		f11.NAME DENAME
		from 
		<include refid="tableName"></include> f1
		left join PP_PurchaseApply f
		on f.PurchaseApply_ID=f1.PurchaseApplyID
		left join KM_Customer f2
		on f.FCustomer=f2.Customer_ID
		left join OA_STAFF f3
		on f.FOrderer=f3.STAFF_ID
		left join OA_STAFF f4
		on f.ApplyPerson=f4.STAFF_ID
		left join OA_STAFF f5
		on f.FMakeBillsPersoID=f5.STAFF_ID
		left join OA_STAFF f6
		on f.FCheckPersonID=f6.STAFF_ID
		left join MBASE_MAT_BASIC f7
		on f7.MAT_BASIC_ID=f1.MaterialID
		left join MBASE_UNIT_INFO f8
		on f7.MAT_MAIN_UNIT=f8.UNIT_INFO_ID
		left join MBASE_MAT_AUXILIARYMX f9
		on f9.MAT_AUXILIARYMX_ID=f1.SPropKey
		left join OA_STAFF f10
		on f1.FPurchaser=f10.STAFF_ID
		
		left join SYS_DICTIONARIES f11
		on f7.MAT_ATTRIBUTE = f11.DICTIONARIES_ID
		where 1=1
		and PurchaseApplyID=#{pd.PurchaseApplyID}
		[fhstart] order by cast(RowNum as int)  [fhend]
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			PurchasDetails_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
		<!-- 删除采购申请关联行关闭明细-->
	<update id="rowCloseByApplyId" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			RowClose = #{RowClose}
		where 
			PurchaseApplyID = #{PurchaseApplyID}
	</update>
	
	<!-- 生成明细行号 -->
	<select id="getRowNum" parameterType="pd" resultType="pd">
		select
		isnull(max(cast(isnull(RowNum,'0') as int)),0)+1 RowNum
		from 
		<include refid="tableName"></include> f
		where PurchaseApplyID = #{PurchaseApplyID}
	</select>
	
	<!-- 行关闭/反行关闭采购申请明细 -->
	<update id="rowClose" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			RowClose = #{RowClose}
		where 
			PurchasDetails_ID = #{PurchasDetails_ID}
	</update>
	
	<!-- 采购申请明细-物料列表 -->
	<select id="listAllMat" parameterType="pd" resultType="pd">
		select * from(
		select
		f.PurchaseApply_ID,	
		f.FCustomer,	
		f.RelationNum,	
		f.BusinessType,	
		f.DataSources,	
		f.FNum,	
		f.FOrderer,	
		f.FExplanation FExplanationMain,	
		f.ApplyPerson,	
		f.FMakeBillsPersoID,	
		f.FMakeBillsTime,	
		f.FCheckPersonID,	
		f.FCheckTime,	
		f.FCheckFlag,
		isnull(f2.FName,'无名称')  +'/'+isnull(f2.FNum,'无编号')  FCustomerJoint,
		f3.NAME FOrdererName,
		f4.NAME ApplyPersonName,
		f5.NAME FMakeBillsPersoIDName,
		f6.NAME FCheckPersonIDName,
		f10.NAME FPurchaserName,
		
		f1.*,
		f8.FNAME FUnitName,
		f7.MAT_CODE,f7.MAT_NAME,
		isnull(f7.MAT_CODE,'无编号')+'/'+isnull(f7.MAT_NAME,'无名称') FMatJoint,
		f7.MAT_AUXILIARY_ID,
		f9.MAT_AUXILIARYMX_NAME,f9.MAT_AUXILIARYMX_CODE,
		cast(isnull(f1.PurchaseApplyKey,'0') as NUMERIC(12,2))-cast(isnull(f1.FPushCount,'0') as NUMERIC(12,2)) FCanUseCount
		
		from 
		<include refid="tableName"></include> f1
		left join PP_PurchaseApply f
		on f.PurchaseApply_ID=f1.PurchaseApplyID
		left join KM_Customer f2
		on f.FCustomer=f2.Customer_ID
		left join OA_STAFF f3
		on f.FOrderer=f3.STAFF_ID
		left join OA_STAFF f4
		on f.ApplyPerson=f4.STAFF_ID
		left join OA_STAFF f5
		on f.FMakeBillsPersoID=f5.STAFF_ID
		left join OA_STAFF f6
		on f.FCheckPersonID=f6.STAFF_ID
		left join MBASE_MAT_BASIC f7
		on f7.MAT_BASIC_ID=f1.MaterialID
		left join MBASE_UNIT_INFO f8
		on f7.MAT_MAIN_UNIT=f8.UNIT_INFO_ID
		left join MBASE_MAT_AUXILIARYMX f9
		on f9.MAT_AUXILIARYMX_ID=f1.SPropKey
		left join OA_STAFF f10
		on f1.FPurchaser=f10.STAFF_ID
		where 1=1
		and f1.RowClose='N'
		<if test="KEYWORDS_FNum != null and KEYWORDS_FNum != ''">
			and f.FNum  = #{KEYWORDS_FNum}
		</if>
		<if test="KEYWORDS_MaterialNum != null and KEYWORDS_MaterialNum != ''">
			and f7.MAT_CODE  LIKE '%'+ #{KEYWORDS_MaterialNum}+'%'  
		</if>
		<if test="KEYWORDS_MaterialName != null and KEYWORDS_MaterialName != ''">
			and f7.MAT_NAME  LIKE '%'+ #{KEYWORDS_MaterialName}+'%'  
		</if>
		<if test="KEYWORDS_FMakeBillsTimeStart != null and KEYWORDS_FMakeBillsTimeStart != ''">
			and convert(varchar(10), f.FMakeBillsTime)  &gt;= #{KEYWORDS_FMakeBillsTimeStart}
		</if>
		<if test="KEYWORDS_FMakeBillsTimeEnd != null and KEYWORDS_FMakeBillsTimeEnd != ''">
			and convert(varchar(10), f.FMakeBillsTime)  &lt;= #{KEYWORDS_FMakeBillsTimeEnd}
		</if>
		<if test="KEYWORDS_DemandTimeStart != null and KEYWORDS_DemandTimeStart != ''">
			and convert(varchar(10), f1.DemandTime)  &gt;= #{KEYWORDS_DemandTimeStart}
		</if>
		<if test="KEYWORDS_DemandTimeEnd != null and KEYWORDS_DemandTimeEnd != ''">
			and convert(varchar(10), f1.DemandTime)  &lt;= #{KEYWORDS_DemandTimeEnd}
		</if>
		) gy
		where 1=1 and FCanUseCount>0
		 order by FNum,cast(RowNum as int) 
	</select>
	
	<!-- 批量选择采购申请物料 -->
	<select id="selectAllCGSQ" parameterType="pd" resultType="pd">
		select * from(
		select
		f.PurchaseApply_ID,	
		f.FCustomer,	
		f.RelationNum,	
		f.BusinessType,	
		f.DataSources,	
		f.FNum,	
		f.FOrderer,	
		f.FExplanation FExplanationMain,	
		f.ApplyPerson,	
		f.FMakeBillsPersoID,	
		f.FMakeBillsTime,	
		f.FCheckPersonID,	
		f.FCheckTime,	
		f.FCheckFlag,
		isnull(f2.FName,'无名称')  +'/'+isnull(f2.FNum,'无编号')  FCustomerJoint,
		f3.NAME FOrdererName,
		f4.NAME ApplyPersonName,
		f5.NAME FMakeBillsPersoIDName,
		f6.NAME FCheckPersonIDName,
		f10.NAME FPurchaserName,
		f1.*,
		f8.FNAME FUnitName,
		f7.MAT_CODE,f7.MAT_NAME,
		isnull(f7.MAT_CODE,'无编号')+'/'+isnull(f7.MAT_NAME,'无名称') FMatJoint,
		f7.MAT_AUXILIARY_ID,
		f9.MAT_AUXILIARYMX_NAME,f9.MAT_AUXILIARYMX_CODE,
		cast(isnull(f1.PurchaseApplyKey,'0') as NUMERIC(12,2))-cast(isnull(f1.FPushCount,'0') as NUMERIC(12,2)) FCanUseCount
		
		from 
		<include refid="tableName"></include> f1
		left join PP_PurchaseApply f
		on f.PurchaseApply_ID=f1.PurchaseApplyID
		left join KM_Customer f2
		on f.FCustomer=f2.Customer_ID
		left join OA_STAFF f3
		on f.FOrderer=f3.STAFF_ID
		left join OA_STAFF f4
		on f.ApplyPerson=f4.STAFF_ID
		left join OA_STAFF f5
		on f.FMakeBillsPersoID=f5.STAFF_ID
		left join OA_STAFF f6
		on f.FCheckPersonID=f6.STAFF_ID
		left join MBASE_MAT_BASIC f7
		on f7.MAT_BASIC_ID=f1.MaterialID
		left join MBASE_UNIT_INFO f8
		on f7.MAT_MAIN_UNIT=f8.UNIT_INFO_ID
		left join MBASE_MAT_AUXILIARYMX f9
		on f9.MAT_AUXILIARYMX_ID=f1.SPropKey
		left join OA_STAFF f10
		on f1.FPurchaser=f10.STAFF_ID
		where 1=1
		and f1.RowClose='N'
		and PurchasDetails_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
		) gy
		where 1=1 and FCanUseCount>0
		 order by FNum,cast(RowNum as int) 
	</select>
	
	<!-- 计算下推数量 -->
	<update id="calFPushCount" parameterType="pd">
update 
f set f.FPushCount=
isnull((
select 
sum(
isnull(f1.FCount,0)
) FNUM
from PP_PurchaseMaterialDetails f1
inner join PP_PurchaseList f2
on f1.PurchaseID=f2.PurchaseList_ID
where 1=1 
and SourceOrderNum=gy1.FNum
and SourceRowNum=f.RowNum
and f1.RowClose='N' 
),0)
from 
PP_PurchasDetails f
inner join PP_PurchaseApply gy1
on gy1.PurchaseApply_ID=f.PurchaseApplyID
where 1=1 
and gy1.FNum=#{SourceOrderNum}
and f.RowNum=#{SourceRowNum}

	</update>
	
		<!-- 修改物料清单的下推状态-->
	<update id="updateFIsPush" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			FIsPush = #{FIsPush}
		where 
			PurchasDetails_ID = #{PurchasDetails_ID}
	</update>
	<!-- yy356703572qq(彬耶) -->
</mapper>