<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.pp.WorkingHoursMapper">
	
	<!--表名 -->
	<sql id="tableName">
		PP_WorkingHours
	</sql>
	
	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		f.PlanningWorkOrder_ID,
		f.ProcessWorkOrderExample_ID,
		f.TaskUnitManHour,
		f.NumberOfParts,
		f.RatedManHour,
		f.StartTime,
		f.EndTime,
		f.ActualManHour,
		isnull(f.AdjustManHour,0)AdjustManHour,
		isnull(f.TotalManHour,0)TotalManHour,
		f.GeneratedType,
		f.FillInTheDescription,
		f.FillInThePersonID,
		f.ReportingTime,
		f.AuditMark,
		f.Examiners,
		f.AuditTime,
		f.AuditOpinion,
		f.WorkingHours_ID
	</sql>
	
	<!-- 字段用于新增 -->
	<sql id="Field2">
		PlanningWorkOrder_ID,
		ProcessWorkOrderExample_ID,
		TaskUnitManHour,
		NumberOfParts,
		RatedManHour,
		StartTime,
		EndTime,
		ActualManHour,
		AdjustManHour,
		TotalManHour,
		GeneratedType,
		FillInTheDescription,
		FillInThePersonID,
		ReportingTime,
		AuditMark,
		Examiners,
		AuditTime,
		AuditOpinion,
		WorkingHours_ID
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{PlanningWorkOrder_ID},
		#{ProcessWorkOrderExample_ID},
		#{TaskUnitManHour},
		#{NumberOfParts},
		#{RatedManHour},
		#{StartTime},
		#{EndTime},
		#{ActualManHour},
		#{AdjustManHour},
		#{TotalManHour},
		#{GeneratedType},
		#{FillInTheDescription},
		#{FillInThePersonID},
		#{ReportingTime},
		#{AuditMark},
		#{Examiners},
		#{AuditTime},
		#{AuditOpinion},
		#{WorkingHours_ID}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field2"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			WorkingHours_ID = #{WorkingHours_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			PlanningWorkOrder_ID = #{PlanningWorkOrder_ID},
			ProcessWorkOrderExample_ID = #{ProcessWorkOrderExample_ID},
			TaskUnitManHour = #{TaskUnitManHour},
			NumberOfParts = #{NumberOfParts},
			RatedManHour = #{RatedManHour},
			StartTime = #{StartTime},
			EndTime = #{EndTime},
			ActualManHour = #{ActualManHour},
			AdjustManHour = #{AdjustManHour},
			TotalManHour = #{TotalManHour},
			FillInTheDescription = #{FillInTheDescription},
			WorkingHours_ID = WorkingHours_ID
		where 
			WorkingHours_ID = #{WorkingHours_ID}
	</update>
	
	<!-- 提交审核 -->
	<update id="goAudit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			AuditMark = #{AuditMark}
		where 
			WorkingHours_ID = #{WorkingHours_ID}
	</update>
	
	<!-- 审核 -->
	<update id="audit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			AuditMark = #{AuditMark},
			Examiners = #{Examiners},
			AuditTime = #{AuditTime},
			AuditOpinion = #{AuditOpinion},
			AdjustManHour = #{AdjustManHour},
			TotalManHour = #{TotalManHour}
		where 
			WorkingHours_ID = #{WorkingHours_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		a.WorkOrderNum,
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		LEFT JOIN PP_PlanningWorkOrder a ON f.PlanningWorkOrder_ID = a.PlanningWorkOrder_ID
		where 
			f.WorkingHours_ID = #{WorkingHours_ID}
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
			select * from (
			
			SELECT
				a.WorkOrderNum,
				b.WPName AS FName,
				c.NAME,
				(SELECT ISNULL(NAME,'') NAME FROM OA_STAFF WHERE STAFF_ID = f.Examiners) ENAME,
				f.PlanningWorkOrder_ID,
				f.ProcessWorkOrderExample_ID,
				f.TaskUnitManHour,
				f.NumberOfParts,
				f.RatedManHour,
				f.StartTime,
				f.EndTime,
				f.ActualManHour,
				f.AdjustManHour,
				f.TotalManHour,
				f.GeneratedType,
				f.FillInTheDescription,
				f.FillInThePersonID,
				f.ReportingTime,
				ISNULL(f.AuditMark,'') AuditMark,
				f.Examiners,
				f.AuditTime,
				f.AuditOpinion,
				f.WorkingHours_ID
			FROM PP_WorkingHours f
			LEFT JOIN PP_PlanningWorkOrder a ON f.PlanningWorkOrder_ID = a.PlanningWorkOrder_ID
			LEFT JOIN PP_ProcessWorkOrderExample b ON f.ProcessWorkOrderExample_ID = b.ProcessWorkOrderExample_ID
			LEFT JOIN OA_STAFF c ON f.FillInThePersonID = c.STAFF_ID
			
			)t
			where 1=1
			<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
				and
					(
					t.WorkOrderNum LIKE '%'+ #{pd.KEYWORDS}+'%'
					or
					t.FName LIKE '%'+ #{pd.KEYWORDS}+'%'
					or
					t.NAME  LIKE '%'+ #{pd.KEYWORDS}+'%'
					)
			</if>
			<if test="pd.CARRYOUT != null and pd.CARRYOUT != '' and pd.CARRYOUT=='yes'"><!-- 关键词检索 -->
				and (
					t.NAME = #{pd.NAME}
					)
			</if>
			[fhstart]ORDER BY t.ReportingTime DESC[fhend]
	</select>
	
	<!-- 列表 -->
	<select id="datalistPageAudit" parameterType="page" resultType="pd">
			SELECT
				a.WorkOrderNum,
				b.WPName AS FName,
				c.NAME,
				(SELECT ISNULL(NAME,'') NAME FROM OA_STAFF WHERE STAFF_ID = f.Examiners) ENAME,
				f.PlanningWorkOrder_ID,
				f.ProcessWorkOrderExample_ID,
				f.TaskUnitManHour,
				f.NumberOfParts,
				f.RatedManHour,
				f.StartTime,
				f.EndTime,
				f.ActualManHour,
				f.AdjustManHour,
				f.TotalManHour,
				f.GeneratedType,
				f.FillInTheDescription,
				f.FillInThePersonID,
				f.ReportingTime,
				ISNULL(f.AuditMark,'') AuditMark,
				f.Examiners,
				f.AuditTime,
				f.AuditOpinion,
				f.WorkingHours_ID
			FROM PP_WorkingHours f
			LEFT JOIN PP_PlanningWorkOrder a ON f.PlanningWorkOrder_ID = a.PlanningWorkOrder_ID
			LEFT JOIN PP_ProcessWorkOrderExample b ON f.ProcessWorkOrderExample_ID = b.ProcessWorkOrderExample_ID
			LEFT JOIN OA_STAFF c ON f.FillInThePersonID = c.STAFF_ID
			where 1=1 and f.AuditMark = '审批中'
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			 and
				( 
				<!--	根据需求自己加检索条件-->
					a.WorkOrderNum LIKE '%'+ #{pd.KEYWORDS}+'%'
					 or 
					b.WPName LIKE '%'+ #{pd.KEYWORDS}+'%' 
				
				) 
		</if>
			[fhstart]ORDER BY f.ReportingTime DESC[fhend]
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		where 1=1 and f.AuditMark = '审批中'
		<if test="AuditMark != null and AuditMark != ''"><!-- 关键词检索 -->
			 and
				( 
				<!--	根据需求自己加检索条件-->
					f.AuditMark=#{AuditMark}
				) 
		</if>
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			WorkingHours_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	
	<!-- 获取单件工时 -->
	<select id="getHour" parameterType="pd" resultType="pd">
		SELECT 
		k.FName,
		k.ProcessWorkOrderExample_ID,
		CASE WHEN k.FCount = 0 THEN 0 ELSE CAST((k.WorkHours/k.FCount) AS DECIMAL(10,4)) END WorkHours FROM
			(
				SELECT 	
				b.wpName as FName,b.ProcessWorkOrderExample_ID,
				CASE
				WHEN b.WorkHoursUnit='天' 
				THEN b.WorkHours * 24 
				WHEN b.WorkHoursUnit='分钟' 
				THEN  CAST((b.WorkHours/60) AS DECIMAL(10,4)) 
				WHEN b.WorkHoursUnit='秒' 
				THEN CAST((b.WorkHours/3600 ) AS DECIMAL(10,4))
				ELSE 
				b.WorkHours 
				END WorkHours,
				b.WorkHoursUnit,
				c.FCount
				FROM PP_ProcessWorkOrderExample b
				LEFT JOIN PP_PlanningWorkOrder c ON b.PlanningWorkOrderID = c.PlanningWorkOrder_ID
				WHERE b.PlanningWorkOrderID = #{KEYWORDS}
			) k
		<!-- SELECT 
		a.ProcessDefinition_ID,
		a.FName,
		b.WorkHours,
		c.FCount,
		CASE WHEN c.FCount = 0 THEN 0 ELSE CAST((b.WorkHours/c.FCount) AS DECIMAL(10,2)) END WorkHourss,
		b.WorkHoursUnit
		FROM KM_ProcessDefinition a 
		LEFT JOIN PP_ProcessWorkOrderExample b ON a.ProcessDefinition_ID = b.WP
		LEFT JOIN PP_PlanningWorkOrder c ON b.PlanningWorkOrderID = c.PlanningWorkOrder_ID
		WHERE b.PlanningWorkOrderID = #{KEYWORDS} -->
	</select>
	
	<!-- yy356703572qq(彬耶) -->
</mapper>