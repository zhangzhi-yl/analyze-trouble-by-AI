<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.system.UsersMapper">

    <resultMap type="User" id="userAndRoleResultMap">
        <id column="USER_ID" property="USER_ID"/>
        <result column="USERNAME" property="USERNAME"/>
        <result column="PASSWORD" property="PASSWORD"/>
        <result column="NAME" property="NAME"/>
        <result column="LAST_LOGIN" property="LAST_LOGIN"/>
        <result column="IP" property="IP"/>
        <result column="STATUS" property="STATUS"/>
        <result column="SKIN" property="SKIN"/>
        <result column="ROLE_IDS" property="ROLE_IDS"/>
        <result column="FSTATION_CODE" property="FSTATION_CODE"/>
        <result column="FSTATION_NAME" property="FSTATION_NAME"/>
        <association property="role" column="ROLE_ID" javaType="Role">
            <id column="ROLE_ID" property="ROLE_ID"/>
            <result column="ROLE_NAME" property="ROLE_NAME"/>
            <result column="ROLE_RIGHTS" property="RIGHTS"/>
            <result column="ADD_QX" property="ADD_QX"/>
            <result column="DEL_QX" property="DEL_QX"/>
            <result column="EDIT_QX" property="EDIT_QX"/>
            <result column="CHA_QX" property="CHA_QX"/>
            <result column="YL1_QX" property="YL1_QX"/>
            <result column="YL2_QX" property="YL2_QX"/>
            <result column="YL3_QX" property="YL3_QX"/>
        </association>
    </resultMap>
    <resultMap type="User" id="userResultMap">
        <id column="USER_ID" property="USER_ID"/>
        <result column="USERNAME" property="USERNAME"/>
        <result column="PASSWORD" property="PASSWORD"/>
        <result column="NAME" property="NAME"/>
        <result column="LAST_LOGIN" property="LAST_LOGIN"/>
        <result column="IP" property="IP"/>
        <result column="STATUS" property="STATUS"/>
        <result column="ROLE_ID" property="ROLE_ID"/>
        <result column="SKIN" property="SKIN"/>
        <result column="ROLE_IDS" property="ROLE_IDS"/>
        <result column="FSTATION_CODE" property="FSTATION_CODE"/>
        <result column="FSTATION_NAME" property="FSTATION_NAME"/>
    </resultMap>

    <!--用户表名 -->
    <sql id="tableName">
        SYS_USER
    </sql>

    <!--角色表名 -->
    <sql id="roleTableName">
        SYS_ROLE
    </sql>

    <!-- 字段 -->
    <sql id="Field">
        USER_ID
        ,
		USERNAME,
		PASSWORD,
		NAME,
		ROLE_ID,
		LAST_LOGIN,
		IP,
		STATUS,
		BZ,
		SKIN,
		EMAIL,
		NUMBER,
		PHONE,
		ROLE_IDS,
		FSTATION_CODE,
		FSTATION_NAME,
		CreateTime
    </sql>

    <!-- 字段值 -->
    <sql id="FieldValue">
        #{USER_ID}
        ,
        #{USERNAME},
        #{PASSWORD},
        #{NAME},
        #{ROLE_ID},
        #{LAST_LOGIN},
        #{IP},
        #{STATUS},
        #{BZ},
        #{SKIN},
        #{EMAIL},
        #{NUMBER},
        #{PHONE},
        #{ROLE_IDS},
        #{FSTATION_CODE},
        #{FSTATION_NAME},
        #{CreateTime}
    </sql>

    <!-- 通过USERNAME获取数据 -->
    <select id="findByUsername" parameterType="pd" resultType="pd">
        select
        f.USER_ID,
        f.USERNAME,
        f.PASSWORD,
        f.NAME,
        f.ROLE_ID,
        f.LAST_LOGIN,
        f.IP,
        f.STATUS,
        f.BZ,
        f.SKIN,
        f.EMAIL,
        f.NUMBER,
        f.PHONE,
        f.ROLE_IDS,
        f.FSTATION_CODE,
        f.FSTATION_NAME,
        f1.Role,
        f1.Premission
        from
        <include refid="tableName"></include>
        f
        left join OA_AppUser f1 on f1.UserName = f.USERNAME
        where
        f.USERNAME = #{USERNAME}
    </select>

    <!-- 通过用户ID获取数据 -->
    <select id="findById" parameterType="pd" resultType="pd">
        select
        f.USER_ID,
        f.USERNAME,
        f.PASSWORD,
        f.NAME,
        f.ROLE_ID,
        f.LAST_LOGIN,
        f.IP,
        f.STATUS,
        f.BZ,
        f.SKIN,
        f.EMAIL,
        f.NUMBER,
        f.PHONE,
        f.ROLE_IDS,
        f.FSTATION_CODE,
        f.FSTATION_NAME,
        f1.Role,
        f1.Premission,
        f1.Token,
        f1.TokenTime,
        r.ROLE_NAME,
        p.PHOTO0 userPhoto
        from
        <include refid="tableName"></include>
        f
        left join OA_AppUser f1 on f1.UserName = f.USERNAME
        left join
        <include refid="roleTableName"></include>
        r
        on f.ROLE_ID=r.ROLE_ID
        left join SYS_USERPHOTO p on f.USERNAME = p.USERNAME
        where
        f.USER_ID = #{USER_ID}
    </select>

    <!-- 通过邮箱获取数据 -->
    <select id="findByEmail" parameterType="pd" resultType="pd">
        select
        <include refid="Field"></include>
        from
        <include refid="tableName"></include>
        where
        EMAIL = #{EMAIL}
        <if test="USERNAME != null and USERNAME != ''">
            and USERNAME &lt;&gt; #{USERNAME}
        </if>
    </select>

    <!-- 通过编码获取数据 -->
    <select id="findByNumbe" parameterType="pd" resultType="pd">
        select
        <include refid="Field"></include>
        from
        <include refid="tableName"></include>
        where
        NUMBER = #{NUMBER}
        <if test="USERNAME != null and USERNAME != ''">
            and USERNAME &lt;&gt; #{USERNAME}
        </if>
    </select>
    <!-- 通过appUsername获取数据 -->
    <select id="findByAppUserName" parameterType="pd" resultType="pd">
        select u.NAME as UName,
               appuser.UserName,
               appuser.Role,
               appuser.Premission,
               appuser.AppUser_ID,
               appuser.Token,
               appuser.TokenTime,
               appuser.Fremark
        from OA_AppUser appuser
                 left join SYS_USER u on appuser.UserName = u.USERNAME
        where appuser.UserName = #{UserName}
    </select>

    <!-- 列出某角色下的所有用户 -->
    <select id="listAllUserByRoldId" parameterType="pd" resultType="pd">
        select USER_ID
        from
        <include refid="tableName"></include>
        where
        ROLE_ID = #{ROLE_ID}
    </select>

    <!-- 新增用户 -->
    <insert id="saveUser" parameterType="pd">
        insert into <include refid="tableName"></include> (
        <include refid="Field"></include>
        ) values (
        <include refid="FieldValue"></include>
        )
    </insert>
    <insert id="saveAppUser" parameterType="pd">
        insert into OA_AppUser
        (UserName, Role, AppUser_ID)
        values (#{UserName}, #{Role}, #{AppUser_ID})
    </insert>

    <!-- 修改 -->
    <update id="editUser" parameterType="pd">
        update
        <include refid="tableName"></include>
        set NAME = #{NAME},
        ROLE_ID = #{ROLE_ID},
        ROLE_IDS = #{ROLE_IDS},
        BZ = #{BZ},
        EMAIL = #{EMAIL},
        NUMBER = #{NUMBER},
        PHONE = #{PHONE}
        <if test="PASSWORD != null and PASSWORD != ''">
            ,PASSWORD = #{PASSWORD}
        </if>
        where
        USER_ID = #{USER_ID}
    </update>

    <update id="uniAppEditUser" parameterType="pd">
        update
        <include refid="tableName"></include>
        set NAME = #{NAME},
        EMAIL = #{EMAIL},
        PHONE = #{PHONE}
        <if test="PASSWORD != null and PASSWORD != ''">
            ,PASSWORD = #{PASSWORD}
        </if>
        where
        USER_ID = #{USER_ID}
    </update>

    <!-- 用户列表 -->
    <select id="userlistPage" parameterType="page" resultType="pd">
        select u.USER_ID,
        u.USERNAME,
        u.PASSWORD,
        u.LAST_LOGIN,
        u.NAME,
        u.IP,
        u.EMAIL,
        u.NUMBER,
        u.PHONE,
        u.CreateTime,
        r.ROLE_ID,
        r.ROLE_NAME
        from <include refid="tableName"></include> u, <include refid="roleTableName"></include> r
        where u.ROLE_ID = r.ROLE_ID
        and u.USERNAME &lt;&gt; 'admin'
        and r.PARENT_ID = '1'
        <if test="pd.KEYWORDS!= null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
            and
            (
            u.USERNAME LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.EMAIL LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.NUMBER LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.NAME LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.PHONE LIKE '%'+#{pd.KEYWORDS}+'%'
            )
        </if>
        <if test="pd.ROLE_ID != null and pd.ROLE_ID != ''">        <!-- 角色检索 -->
            and u.ROLE_ID=#{pd.ROLE_ID}
        </if>
        <if test="pd.STRARTTIME!=null and pd.STRARTTIME!=''">    <!-- 登录时间检索 -->
            and u.LAST_LOGIN &gt;= #{pd.STRARTTIME}
        </if>
        <if test="pd.ENDTIME!=null and pd.ENDTIME!=''">            <!-- 登录时间检索 -->
            and u.LAST_LOGIN &lt;= #{pd.ENDTIME}
        </if>
        [fhstart]order by u.CreateTime desc[fhend]
    </select>

    <!-- 用户列表(全部) -->
    <select id="listAllUser" parameterType="pd" resultType="pd">
        select u.USER_ID,
        u.USERNAME,
        u.PASSWORD,
        u.LAST_LOGIN,
        u.NAME,
        u.IP,
        u.EMAIL,
        u.NUMBER,
        u.PHONE,
        r.ROLE_ID,
        r.ROLE_NAME
        from <include refid="tableName"></include> u, <include refid="roleTableName"></include> r
        where u.ROLE_ID = r.ROLE_ID
        and u.USERNAME &lt;&gt; 'admin'
        and r.PARENT_ID = '1'
        <if test="KEYWORDS != null and KEYWORDS != ''"><!-- 关键词检索 -->
            and
            (
            u.USERNAME LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.EMAIL LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.NUMBER LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.NAME LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.PHONE LIKE '%'+#{pd.KEYWORDS}+'%'
            )
        </if>
        <if test="ROLE_ID != null and ROLE_ID != ''"><!-- 角色检索 -->
            and u.ROLE_ID=#{ROLE_ID}
        </if>
        <if test="STRARTTIME!=null and STRARTTIME!=''"><!-- 登录时间检索 -->
            and u.LAST_LOGIN &gt;= #{STRARTTIME}
        </if>
        <if test="ENDTIME!=null and ENDTIME!=''"><!-- 登录时间检索 -->
            and u.LAST_LOGIN &lt;= #{ENDTIME}
        </if>
        order by u.LAST_LOGIN desc
    </select>

    <select id="listAll" parameterType="pd" resultType="pd">
        select u.USER_ID,
        u.USERNAME,
        u.PASSWORD,
        u.LAST_LOGIN,
        u.NAME,
        u.IP,
        u.EMAIL,
        u.NUMBER,
        u.PHONE
        from <include refid="tableName"></include> u
    </select>

    <update id="editAppUser" parameterType="pd">
        update OA_AppUser
        set Role = #{Role},
        Premission = #{Premission}
        <if test="Token != null and Token != ''">
            ,Token = #{Token}
        </if>
        <if test="TokenTime != null and TokenTime != ''">
            ,TokenTime = #{TokenTime}
        </if>
        where
        UserName = #{UserName}
    </update>

    <update id="editAppUserTokenTime" parameterType="pd">
        update OA_AppUser
        set
        TokenTime = #{TokenTime}
        where
        UserName = #{UserName}
    </update>

    <update id="editAppUserToken" parameterType="pd">
        update OA_AppUser
        set Token     = null,
            TokenTime = null
        where UserName = #{UserName}
    </update>
    <!-- 通过appUsername获取数据 -->
    <select id="findAppUserTimeByToken" parameterType="pd" resultType="pd">
        select u.NAME as UName,
               appuser.UserName,
               appuser.Role,
               appuser.Premission,
               appuser.AppUser_ID,
               appuser.Token,
               appuser.TokenTime,
               appuser.Fremark
        from OA_AppUser appuser
                 left join SYS_USER u on appuser.UserName = u.USERNAME
        where appuser.Token = #{Token}
    </select>


    <!-- 通过用户ID获取用户信息和角色信息 -->
    <select id="getUserAndRoleById" parameterType="String" resultMap="userAndRoleResultMap">
        select u.USER_ID,
        u.USERNAME,
        u.NAME,
        u.PASSWORD,
        u.SKIN,
        u.NUMBER,
        u.ROLE_IDS,
        u.FSTATION_CODE,
        u.FSTATION_NAME,
        r.ROLE_ID,
        r.ROLE_NAME,
        r.RIGHTS as ROLE_RIGHTS,
        r.ADD_QX,
        r.DEL_QX,
        r.EDIT_QX,
        r.CHA_QX,
        r.YL1_QX,
        r.YL2_QX,
        r.YL3_QX
        from
        <include refid="tableName"></include>
        u
        left join
        <include refid="roleTableName"></include>
        r
        on u.ROLE_ID=r.ROLE_ID
        where u.STATUS=0
        and u.USER_ID=#{USER_ID}
    </select>

    <!-- 用户列表(弹窗选择用) -->
    <select id="userBystafflistPage" parameterType="page" resultType="pd">
        select u.USER_ID,
        u.USERNAME,
        u.PASSWORD,
        u.LAST_LOGIN,
        u.NAME,
        u.IP,
        u.EMAIL,
        u.NUMBER,
        u.PHONE,
        r.ROLE_ID,
        r.ROLE_NAME
        from <include refid="tableName"></include> u, <include refid="roleTableName"></include> r
        where u.ROLE_ID = r.ROLE_ID
        and u.USERNAME != 'admin'
        and r.PARENT_ID = '1'
        <if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
            and
            (
            u.USERNAME LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.EMAIL LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.NUMBER LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.NAME LIKE '%'+#{pd.KEYWORDS}+'%'
            or
            u.PHONE LIKE '%'+#{pd.KEYWORDS}+'%'
            )
        </if>
        <if test="pd.ROLE_ID != null and pd.ROLE_ID != ''"><!-- 角色检索 -->
            and u.ROLE_ID=#{pd.ROLE_ID}
        </if>
        <if test="pd.STRARTTIME!=null and pd.STRARTTIME!=''">    <!-- 登录时间检索 -->
            and u.LAST_LOGIN &gt;= #{pd.STRARTTIME}
        </if>
        <if test="pd.ENDTIME!=null and pd.ENDTIME!=''">            <!-- 登录时间检索 -->
            and u.LAST_LOGIN &lt;= #{pd.ENDTIME}
        </if>
        [fhstart]order by u.LAST_LOGIN desc[fhend]
    </select>

    <!-- 存入IP -->
    <update id="saveIP" parameterType="pd">
        update
        <include refid="tableName"></include>
        set
        IP = #{IP},
        LAST_LOGIN = #{LAST_LOGIN}
        where
        USERNAME = #{USERNAME}
    </update>

    <!-- 保存用户皮肤 -->
    <update id="saveSkin" parameterType="pd">
        update
        <include refid="tableName"></include>
        set
        SKIN = #{SKIN}
        where USERNAME = #{USERNAME}
    </update>

    <!-- 删除用户 -->
    <delete id="deleteUser" parameterType="pd">
        delete from
        <include refid="tableName"></include>
        where
        USER_ID = #{USER_ID}
        and
        USER_ID &lt;&gt; '1'
    </delete>

    <!-- 批量删除用户 -->
    <delete id="deleteAllUser" parameterType="String">
        delete from
        <include refid="tableName"></include>
        where
        USER_ID in
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
            #{item}
        </foreach>
        and
        USER_ID &lt;&gt; '1'
    </delete>

    <!-- 切换工作站 -->
    <update id="editStation" parameterType="pd">
        update
        <include refid="tableName"></include>
        set
        FSTATION_CODE = #{FSTATION_CODE},
        FSTATION_NAME = #{FSTATION_NAME}
        where
        USERNAME = #{USERNAME}
    </update>

    <!-- 通过用户名查询当前工作站 -->
    <select id="findByStation" parameterType="pd" resultType="pd">
        select TOP 1 ISNULL(f.FSTATION_CODE, '') AS FSTATION_CODE,ISNULL(f.FSTATION_NAME, '') AS FSTATION_NAME
        FROM SYS_USER f
        WHERE USERNAME = #{USERNAME}
    </select>
    <!-- 通过用户名查询用户信息 -->
    <select id="findUser" parameterType="pd" resultType="pd">
        select *
        FROM SYS_USER f
        WHERE NAME = #{NAME}
    </select>

    <!-- 通过用户ID获取用户信息和角色信息 -->
    <select id="listAllByRoleName" parameterType="pd" resultType="pd">
        select u.USER_ID,
        u.USERNAME,
        u.NAME,
        u.PASSWORD,
        u.SKIN,
        u.NUMBER,
        u.ROLE_IDS,
        u.FSTATION_CODE,
        u.FSTATION_NAME,
        r.ROLE_ID,
        r.ROLE_NAME,
        r.RIGHTS as ROLE_RIGHTS,
        r.ADD_QX,
        r.DEL_QX,
        r.EDIT_QX,
        r.CHA_QX,
        r.YL1_QX,
        r.YL2_QX,
        r.YL3_QX
        from
        <include refid="tableName"></include>
        u
        left join
        <include refid="roleTableName"></include>
        r
        on u.ROLE_ID=r.ROLE_ID
        where u.STATUS=0
        and r.ROLE_NAME=#{ROLE_NAME}
    </select>
    <!--YY356703572 -->
</mapper>