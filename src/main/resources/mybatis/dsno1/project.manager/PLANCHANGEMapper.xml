<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.dprojectManager.PLANCHANGEMapper">
	
	<!--表名 -->
	<sql id="tableName">
		DT_PLANCHANGE
	</sql>
	
	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		f.PCPROJECT_ID,	
		f.PCEQUIPMENT_ID,	
		f.PCSTAFFPLAN_ID,	
		f.PCPROJECTTASK_ID,	
		f.PCPRINCIPAL,	
		f.PCPLANSTARTDATE,	
		f.PCPLANENDDATE,	
		f.PCNEWSTARTDATE,	
		f.PCNEWENDDATE,	
		f.PCPHASENAME,	
		f.PCACTIVITYNAME,	
		f.PCTASK_NAME,	
		f.PCPROJECT_PRINCIPAL,	
		f.PCPOSTMAN,	
		f.PCPOSTTIME,	
		f.PCCHANGEREASON,	
		f.RUN_STATUS,	
		f.PROC_INST_ID_,	
		f.GENERATE_PROGRESS,	
		f.PCDEPT,	
		f.PCCREATOR,	
		f.PCCREATE_TIME,	
		f.PCLAST_MODIFIER,	
		f.PCLAST_MODIFIED_TIME,	
		f.PLANCHANGE_ID,
		f.PCVISIBLE
	</sql>
	
	<!-- 字段用于新增 -->
	<sql id="Field2">
		PCPROJECT_ID,	
		PCEQUIPMENT_ID,	
		PCSTAFFPLAN_ID,	
		PCPROJECTTASK_ID,	
		PCPRINCIPAL,	
		PCPLANSTARTDATE,	
		PCPLANENDDATE,	
		PCNEWSTARTDATE,	
		PCNEWENDDATE,	
		PCPHASENAME,	
		PCACTIVITYNAME,	
		PCTASK_NAME,	
		PCPROJECT_PRINCIPAL,	
		PCPOSTMAN,	
		PCPOSTTIME,	
		PCCHANGEREASON,	
		RUN_STATUS,	
		PROC_INST_ID_,	
		GENERATE_PROGRESS,	
		PCDEPT,	
		PCCREATOR,	
		PCCREATE_TIME,	
		PCLAST_MODIFIER,	
		PCLAST_MODIFIED_TIME,	
		PLANCHANGE_ID,
		PCVISIBLE
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{PCPROJECT_ID},	
		#{PCEQUIPMENT_ID},	
		#{PCSTAFFPLAN_ID},	
		#{PCPROJECTTASK_ID},	
		#{PCPRINCIPAL},	
		#{PCPLANSTARTDATE},	
		#{PCPLANENDDATE},	
		#{PCNEWSTARTDATE},	
		#{PCNEWENDDATE},	
		#{PCPHASENAME},	
		#{PCACTIVITYNAME},	
		#{PCTASK_NAME},	
		#{PCPROJECT_PRINCIPAL},	
		#{PCPOSTMAN},	
		#{PCPOSTTIME},	
		#{PCCHANGEREASON},	
		#{RUN_STATUS},	
		#{PROC_INST_ID_},	
		#{GENERATE_PROGRESS},	
		#{PCDEPT},	
		#{PCCREATOR},	
		#{PCCREATE_TIME},	
		#{PCLAST_MODIFIER},	
		#{PCLAST_MODIFIED_TIME},	
		#{PLANCHANGE_ID},
		#{PCVISIBLE}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field2"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			PLANCHANGE_ID = #{PLANCHANGE_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			PCNEWSTARTDATE = #{PCNEWSTARTDATE},
			PCNEWENDDATE = #{PCNEWENDDATE},
			PCCHANGEREASON = #{PCCHANGEREASON},
			PCLAST_MODIFIER = #{PCLAST_MODIFIER},
			PCLAST_MODIFIED_TIME = #{PCLAST_MODIFIED_TIME}
		where 
			PLANCHANGE_ID = #{PLANCHANGE_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
select a.*,b.*,c.PPROJECT_CODE,c.PPROJECT_NAME,d.EEQM_NO,d.EEQM_NAME,a.PCNEWSTARTDATE STARTDATE,a.PCNEWENDDATE ENDDATE,
isnull(f3.STAFFPLAN_ID,'') STAFFPLAN_ID,
isnull(f4.DEPPLAN_ID,'') DEPPLAN_ID,
isnull(f5.PRO_PLAN_ID,'') PRO_PLAN_ID
from DT_PLANCHANGE a 
left join DT_PROJECTTASK b 
on a.PCPROJECTTASK_ID=b.PROJECTTASK_ID
left join DT_PROJECT c
on b.PTPROJECT_ID=c.PROJECT_ID
left join DT_EQUIPMENT d
on b.PTEQUIPMENT_ID=d.EQUIPMENT_ID

left join DT_STAFFPLAN f3
on b.PTSTAFFPLAN_ID=f3.STAFFPLAN_ID
left join DT_DEPPLAN f4 
on f3.DEPPLAN_ID = f4.DEPPLAN_ID 
left join DT_PRO_PLAN f5
on f4.PRO_PLAN_ID = f5.PRO_PLAN_ID 
where 
1=1
<choose>
        <when test="FTYPE != null and FTYPE == 'FTYPE1'">
        and a.PROC_INST_ID_ = #{PROC_INST_ID_}
		</when>
        <otherwise>     
        and a.PLANCHANGE_ID = #{PLANCHANGE_ID}      
        </otherwise>
</choose>
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		where 1=1
		and f.PCPROJECTTASK_ID = #{pd.PCPROJECTTASK_ID}
		and f.PCVISIBLE='1'
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
				(
				<!--	根据需求自己加检索条件
					字段1 LIKE '%'+ #{pd.KEYWORDS}+'%'
					 or 
					字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' 
				-->
				)
		</if>
		[fhstart] order by PCCREATE_TIME desc [fhend]
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			PLANCHANGE_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>

	<select id="getStaffPlan" parameterType="pd" resultType="pd">
		select 
			f.*,
			b.FHTNAME,
			b.FHTLEVEL,
      		c.PROJECT_ID,
			c.EQUIPMENT_ID,
			e.EPROJECT_PRINCIPAL,
			d.PPROJECT_NAME,
			d.PPROJECT_CODE,
			b.FHTNAME,
			f.STAFFPLAN_NAME,
			g.DEPARTMENT_ID,
			h.PROJECTTASK_ID,
			e.EEQM_NO,	
			e.EEQM_NAME
		from 
			DT_STAFFPLAN f
		left join 
			DT_DEPPLAN b 
			on f.DEPPLAN_ID = b.DEPPLAN_ID 
		left join 
			DT_PROJECTTASK h 
			on f.STAFFPLAN_ID = h.PTSTAFFPLAN_ID 
		left join 
			DT_PRO_PLAN c 
			on b.PRO_PLAN_ID = c.PRO_PLAN_ID 
			LEFT JOIN DT_PROJECT d ON c.PROJECT_ID = d.PROJECT_ID
			LEFT JOIN DT_EQUIPMENT e ON c.EQUIPMENT_ID = e.EQUIPMENT_ID
			LEFT JOIN OA_STAFF g ON f.STAFFPLAN_MANAGER = g.NAME
		where 
			f.STAFFPLAN_ID = #{STAFFPLAN_ID}  and f.VISIABLE = '1'
	</select>
	<!--反写删除状态-->
	<update id="upVisible" parameterType="pd">
	
		update
		<include refid="tableName"></include>
		set 
			PCVISIBLE = #{PCVISIBLE}
		where 
			PLANCHANGE_ID = #{PLANCHANGE_ID}				
		
	</update>
	<!-- 获得启动审核准备信息-->
	<select id="getAudit" parameterType="pd" resultType="pd">
select f1.PLANCHANGE_ID,f2.NAME,f2.DEPARTMENT_ID,
(case when f1.PCNEWSTARTDATE>f1.PCPLANENDDATE  or  f1.PCNEWENDDATE>f1.PCPLANENDDATE then '超期' ELSE '正常' END) FSTATE,
f2.HEADMAN
 from DT_PLANCHANGE f1
left join OA_DEPARTMENT f2
on f1.PCDEPT=f2.DEPARTMENT_ID
where
f1.PLANCHANGE_ID=#{PLANCHANGE_ID}
	</select>
	
	<!-- 根据姓名查用户表 -->
	<select id="findUser" parameterType="pd" resultType="pd">
		select
		USERNAME
		from 
		SYS_USER f
		where NAME=#{NAME}
	</select>
	<!-- yy356703572qq(彬耶) -->
</mapper>