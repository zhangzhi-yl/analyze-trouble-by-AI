<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.dprojectManager.DTPROJECTFILEMapper">
	
	<!--表名 -->
	<sql id="tableName">
		DT_DTPROJECTFILE
	</sql>
	
	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		f.EQUIPMENT_ID,	
		f.FFILENAME,	
		f.FFILEPATH,	
		f.FFILETYPE,	
		f.PEOJECT_STAGE,	
		f.ACTIVITIES_FNAME,	
		f.DEPTMENT_FNAME,	
		f.DEPTMENT_ID,	
		f.FFOUNDER,	
		f.FFOUNDERNUM,	
		f.FCREATTIME,	
		f.FLASTUPDATE,	
		f.FLASTUPDATENUM,	
		f.FLASTUPDATETIME,	
		f.YL1,	
		f.YL2,	
		f.YL3,	
		f.YL4,	
		f.YL5,	
		f.PROJECT_ID,
		f.VISIABLE,	
		f.DTPROJECTFILE_ID
	</sql>
	
	<!-- 字段用于新增 -->
	<sql id="Field2">
		EQUIPMENT_ID,	
		FFILENAME,	
		FFILEPATH,	
		FFILETYPE,	
		PEOJECT_STAGE,	
		ACTIVITIES_FNAME,	
		DEPTMENT_FNAME,	
		DEPTMENT_ID,	
		FFOUNDER,	
		FFOUNDERNUM,	
		FCREATTIME,	
		FLASTUPDATE,	
		FLASTUPDATENUM,	
		FLASTUPDATETIME,	
		YL1,	
		YL2,	
		YL3,	
		YL4,	
		YL5,	
		PROJECT_ID,
		VISIABLE,	
		DTPROJECTFILE_ID
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{EQUIPMENT_ID},	
		#{FFILENAME},	
		#{FFILEPATH},	
		#{FFILETYPE},	
		#{PEOJECT_STAGE},	
		#{ACTIVITIES_FNAME},	
		#{DEPTMENT_FNAME},	
		#{DEPTMENT_ID},	
		#{FFOUNDER},	
		#{FFOUNDERNUM},	
		#{FCREATTIME},	
		#{FLASTUPDATE},	
		#{FLASTUPDATENUM},	
		#{FLASTUPDATETIME},	
		#{YL1},	
		#{YL2},	
		#{YL3},	
		#{YL4},	
		#{YL5},	
		#{PROJECT_ID},
		#{VISIABLE},	
		#{DTPROJECTFILE_ID}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field2"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			DTPROJECTFILE_ID = #{DTPROJECTFILE_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			EQUIPMENT_ID = #{EQUIPMENT_ID},
			FFILENAME = #{FFILENAME},
			FFILEPATH = #{FFILEPATH},
			FFILETYPE = #{FFILETYPE},
			PEOJECT_STAGE = #{PEOJECT_STAGE},
			ACTIVITIES_FNAME = #{ACTIVITIES_FNAME},
			DEPTMENT_FNAME = #{DEPTMENT_FNAME},
			DEPTMENT_ID = #{DEPTMENT_ID},
			FLASTUPDATE = #{FLASTUPDATE},
			FLASTUPDATENUM = #{FLASTUPDATENUM},
			FLASTUPDATETIME = #{FLASTUPDATETIME},
			PROJECT_ID = #{PROJECT_ID},
			DTPROJECTFILE_ID = DTPROJECTFILE_ID
		where 
			DTPROJECTFILE_ID = #{DTPROJECTFILE_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		where 
			f.DTPROJECTFILE_ID = #{DTPROJECTFILE_ID}
	</select>
	
	<!-- 列表 -->
	<!-- <select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		where 1=1 and VISIABLE = '1'
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''">关键词检索
			and
				(
					根据需求自己加检索条件
					字段1 LIKE '%'+ #{pd.KEYWORDS}+'%'
					 or 
					字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' 
				
				)
		</if>
	</select> -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		SELECT * FROM 
		(SELECT a.*,
		ISNULL(b.PPROJECT_NAME,'') PROJECT_FNAME,
		ISNULL(b.PPROJECT_CODE,'') PROJECT_FCODE,
		ISNULL(c.EEQM_NAME,'') EQUIPMENT_FCODE,
		ISNULL(c.EEQM_NO,'') EQUIPMENT_FNAME,
		ISNULL(d.FHTNAME,'') FHTNAME,
		ISNULL(e.PTACTIVITYNAME,'') PTACTIVITYNAME,
		SUBSTRING(a.FFILENAME, CHARINDEX('.', a.FFILENAME)+1, LEN(a.FFILENAME) - CHARINDEX('.', a.FFILENAME)) AS FILES,
		CASE WHEN a.PROJECT_ID = '' OR a.PROJECT_ID IS NULL THEN '1' ELSE b.PVISIBLE END BVIASBLE,
		CASE WHEN a.EQUIPMENT_ID = '' OR a.EQUIPMENT_ID IS NULL THEN '1' ELSE c.EVISIBLE END CVISABLE,
		CASE WHEN a.PEOJECT_STAGE = '' OR a.PEOJECT_STAGE IS NULL THEN '1' ELSE d.VISIABLE END DVISABLE,
		cASE WHEN a.ACTIVITIES_FNAME = '' OR a.ACTIVITIES_FNAME IS NULL THEN '1' ELSE e.PTVISIBLE END EVISABLE
		FROM 
		DT_DTPROJECTFILE a LEFT JOIN DT_PROJECT b ON a.PROJECT_ID = b.PROJECT_ID
		LEFT JOIN DT_EQUIPMENT c ON a.EQUIPMENT_ID = c.EQUIPMENT_ID 
		LEFT JOIN DT_DEPPLAN d ON a.PEOJECT_STAGE = d.DEPPLAN_ID
		LEFT JOIN DT_PROJECTTASK e ON a.ACTIVITIES_FNAME = e.PROJECTTASK_ID) t 
		WHERE 
		t.VISIABLE = '1'<!--  AND t.BVIASBLE = '1' --> AND t.CVISABLE = '1' AND t.DVISABLE = '1' AND t.EVISABLE = '1'
		<choose>
               	<when test="pd.type != null and pd.type == 'type1'"><!-- 项目列表入口 -->
				and t.PROJECT_ID=#{pd.PID}
				</when>
               <when test="pd.type != null and pd.type == 'type2'"><!-- 项目任务反馈入口 -->
				and t.ACTIVITIES_FNAME=#{pd.PID}
				</when>
                <otherwise>            
                </otherwise>
         </choose>
         <if test="pd.KEYWORDS1 != null and pd.KEYWORDS1 != ''"><!-- 关键词检索 -->
         	AND (
         			t.PROJECT_FNAME LIKE '%' + #{pd.KEYWORDS1} +'%' 
         			OR 
         			t.PROJECT_FCODE = #{pd.KEYWORDS1}
         		)
         </if>
         <if test="pd.KEYWORDS2 != null and pd.KEYWORDS2 != ''"><!-- 关键词检索 -->
         	AND (
         			t.EQUIPMENT_FNAME LIKE '%' + #{pd.KEYWORDS2} +'%' 
         			OR 
         			t.EQUIPMENT_FCODE = #{pd.KEYWORDS2}
         		)
         </if>
         <if test="pd.KEYWORDS3 != null and pd.KEYWORDS3 != ''"><!-- 关键词检索 -->
         	AND t.FHTNAME LIKE '%' + #{pd.KEYWORDS3} + '%'
         </if>
         <if test="pd.KEYWORDS4 != null and pd.KEYWORDS4 != ''"><!-- 关键词检索 -->
         	AND t.PTACTIVITYNAME LIKE '%' + #{pd.KEYWORDS4} + '%'
         </if>
         <if test="pd.KEYWORDS5 != null and pd.KEYWORDS5 != ''"><!-- 关键词检索 -->
         	AND t.FFILENAME LIKE '%' + #{pd.KEYWORDS5} + '%'
         </if>
         <if test="pd.KEYTYPE != null and pd.KEYTYPE != ''"><!-- 关键词检索 -->
         	AND FFILETYPE = #{pd.KEYTYPE}
         </if>
		[fhstart] ORDER BY t.FCREATTIME DESC [fhend]
	</select>
	
		<select id="dataxlistPage" parameterType="page" resultType="pd">
		SELECT * FROM 
		(SELECT a.*,
		ISNULL(b.PPROJECT_NAME,'') PROJECT_FNAME,
		ISNULL(b.PPROJECT_CODE,'') PROJECT_FCODE,
		ISNULL(c.EEQM_NAME,'') EQUIPMENT_FCODE,
		ISNULL(c.EEQM_NO,'') EQUIPMENT_FNAME,
		ISNULL(d.FHTNAME,'') FHTNAME,
		ISNULL(e.PTACTIVITYNAME,'') PTACTIVITYNAME,
		CASE WHEN a.PROJECT_ID = '' OR a.PROJECT_ID IS NULL THEN '1' ELSE b.PVISIBLE END BVIASBLE,
		CASE WHEN a.EQUIPMENT_ID = '' OR a.EQUIPMENT_ID IS NULL THEN '1' ELSE c.EVISIBLE END CVISABLE,
		CASE WHEN a.PEOJECT_STAGE = '' OR a.PEOJECT_STAGE IS NULL THEN '1' ELSE d.VISIABLE END DVISABLE,
		cASE WHEN a.ACTIVITIES_FNAME = '' OR a.ACTIVITIES_FNAME IS NULL THEN '1' ELSE e.PTVISIBLE END EVISABLE
		FROM 
		DT_DTPROJECTFILE a LEFT JOIN DT_PROJECT b ON a.PROJECT_ID = b.PROJECT_ID
		LEFT JOIN DT_EQUIPMENT c ON a.EQUIPMENT_ID = c.EQUIPMENT_ID 
		LEFT JOIN DT_DEPPLAN d ON a.PEOJECT_STAGE = d.DEPPLAN_ID
		LEFT JOIN DT_PROJECTTASK e ON a.ACTIVITIES_FNAME = e.PROJECTTASK_ID) t 
		WHERE 
		1=1
		
		and t.VISIABLE = '1' AND t.BVIASBLE = '1' AND t.CVISABLE = '1' AND t.DVISABLE = '1' AND t.EVISABLE = '1'
		[fhstart] ORDER BY t.FCREATTIME DESC [fhend]
	</select>
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		where VISIABLE = '1'
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			DTPROJECTFILE_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	
	<!-- 获取项目列表 -->
	<select id="listProAll" parameterType="pd" resultType="pd">
		SELECT 
		isnull(PROJECT_ID,'') PROJECT_ID,
		isnull(PPROJECT_NAME,'') PROJECT_FNAME
		FROM DT_PROJECT WHERE PVISIBLE = '1'
	</select>
	<!-- 通过id获取项目编号 -->
	<!-- <select id="findProById" parameterType="pd" resultType="pd">
		SELECT 
		isnull(PPROJECT_CODE,'') PROJECT_FCODE
		FROM DT_PROJECT 
		WHERE PROJECT_ID = #{PROJECT_ID} AND PVISIBLE = '1'
	</select> -->
	<!-- 获取产品列表 -->
	<select id="listEquAll" parameterType="pd" resultType="pd">
		SELECT 
		isnull(EQUIPMENT_ID,'') EQUIPMENT_ID,
		isnull(EEQM_NAME,'') EQUIPMENT_FNAME
		FROM DT_EQUIPMENT 
		WHERE EPROJECT_ID = #{PROJECT_ID} AND EVISIBLE = '1'
	</select>
	<!-- 获取阶段列表 -->
	<select id="listStaAll" parameterType="pd" resultType="pd">
		SELECT 
		isnull(a.FHTNAME,'') FHTNAME,
		isnull(a.DEPPLAN_ID,'') PEOJECT_STAGE
		FROM DT_DEPPLAN a LEFT JOIN DT_PRO_PLAN b ON a.PRO_PLAN_ID = b.PRO_PLAN_ID
		LEFT JOIN DT_EQUIPMENT c ON b.EQUIPMENT_ID = c.EQUIPMENT_ID 
		WHERE c.EQUIPMENT_ID = #{EQUIPMENT_ID} 
		AND a.VISIABLE = '1'
		AND b.VISIABLE = '1' 
		AND c.EVISIBLE = '1' 
		AND a.FTYPE = '已下发'
	</select>
	<!-- 获取活动名称列表 -->
	<select id="listActAll" parameterType="pd" resultType="pd">
		SELECT 
		isnull(a.PROJECTTASK_ID,'') ACTIVITIES_FNAME,
		isnull(a.PTACTIVITYNAME,'') PTACTIVITYNAME
		FROM 
		DT_PROJECTTASK a LEFT JOIN DT_STAFFPLAN b ON a.PTSTAFFPLAN_ID = b.STAFFPLAN_ID 
		LEFT JOIN DT_DEPPLAN c ON b.DEPPLAN_ID = c.DEPPLAN_ID 
		WHERE c.DEPPLAN_ID = #{PEOJECT_STAGE}
		and a.PTVISIBLE = '1' 
		AND b.VISIABLE = '1' 
		AND c.VISIABLE = '1'
	</select>
	<!-- 新增页获取数据 -->
	<select id="getDatax" parameterType="pd" resultType="pd">
		<choose>	
               <when test="type != null and type == 'type2'"><!-- 项目任务反馈入口 -->
				select a.PROJECTTASK_ID,a.PTPROJECT_ID,a.PTEQUIPMENT_ID,b.DEPPLAN_ID from DT_PROJECTTASK a
				left join DT_STAFFPLAN b
				on a.PTSTAFFPLAN_ID=b.STAFFPLAN_ID
				where PROJECTTASK_ID=#{PID}
				</when>
                <otherwise>            
                </otherwise>
         </choose>
		select 
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		where 
			f.DTPROJECTFILE_ID = #{DTPROJECTFILE_ID}
	</select>
	
	<!-- 修改 -->
	<update id="updateDel" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			VISIABLE = #{VISIABLE}
		where 
			DTPROJECTFILE_ID = #{DTPROJECTFILE_ID}
	</update>
	<!-- 新增-->
	<insert id="insert" parameterType="pd">
		insert into 
	DT_DTPROJECTFILE
		(
	EQUIPMENT_ID,	
		FFILENAME,	
		FFILEPATH,	
		FFILETYPE,	
		PEOJECT_STAGE,	
		ACTIVITIES_FNAME,	
		DEPTMENT_FNAME,	
		DEPTMENT_ID,	
		FFOUNDER,	
		FFOUNDERNUM,	
		FCREATTIME,	
		FLASTUPDATE,	
		FLASTUPDATENUM,	
		FLASTUPDATETIME,	
		YL1,	
		YL2,	
		YL3,	
		YL4,	
		YL5,	
		PROJECT_ID,
		VISIABLE,	
		DTPROJECTFILE_ID
		) 
		select 
			EQUIPMENT_ID,	
		FFILENAME,	
		FFILEPATH,	
		FFILETYPE,	
		PEOJECT_STAGE,	
		ACTIVITIES_FNAME,	
		DEPTMENT_FNAME,	
		DEPTMENT_ID,	
		FFOUNDER,	
		FFOUNDERNUM,	
		FCREATTIME,	
		FLASTUPDATE,	
		FLASTUPDATENUM,	
		FLASTUPDATETIME,	
		YL1,	
		YL2,	
		YL3,	
		YL4,	
		YL5,	
		#{PROJECT_ID} PROJECT_ID,
		VISIABLE,
		replace(lower(newId()),'-','') DTPROJECTFILE_ID
		from DT_DTPROJECTFILE where PROJECT_ID=#{PRESALEPLAN_ID}

	</insert>
	<!-- 根据类型获取项目申请附件 -->
	<select id="findFJ" parameterType="pd" resultType="pd">
	select count(*) FNUM from DT_DTPROJECTFILE where FFILETYPE=#{FFILETYPE} and PROJECT_ID=#{PROJECT_ID}
	</select>
</mapper>