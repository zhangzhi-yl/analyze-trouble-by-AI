<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.project.manager.DepPlanMapper">
	
	<!--表名 -->
	<sql id="tableName">
		DT_DEPPLAN
	</sql>
	
	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		f.PHASETEMPLATE_ID,	
		f.RUNTYPE,	
		f.FMANAGER,	
		f.PLAN_START_TIME,	
		f.PLAN_END_TIME,	
		f.PLAN_HOURS,	
		f.FTYPE,	
		f.YL1,	
		f.YL2,	
		f.YL3,	
		f.YL4,	
		f.YL5,	
		f.VISIABLE,	
		f.DEPPLAN_ID,
		f.FHTNAME,
		f.FHTLEVEL,
		f.PRO_PLAN_ID,
		f.ETYPE,
		f.NEW_PLAN_START_TIME,
		f.NEW_PLAN_END_TIME,
		f.REAL_SATRT_TIME,
		f.REAL_END_TIME,
		f.NOW_PLAN_TYPE,
		f.FSOURCE,
		f.DPACTUAL_HOUR,
		f.DPNORMAL_HOUR,
		f.DPOVER_HOUR
	</sql>
	
	<!-- 字段用于新增 -->
	<sql id="Field2">
		PHASETEMPLATE_ID,	
		RUNTYPE,	
		FMANAGER,	
		PLAN_START_TIME,	
		PLAN_END_TIME,	
		PLAN_HOURS,	
		FTYPE,	
		YL1,	
		YL2,	
		YL3,	
		YL4,	
		YL5,	
		VISIABLE,	
		DEPPLAN_ID,
		FHTNAME,
		FHTLEVEL,
		PRO_PLAN_ID,
		ETYPE,
		NEW_PLAN_START_TIME,
		NEW_PLAN_END_TIME,
		REAL_SATRT_TIME,
		REAL_END_TIME,
		NOW_PLAN_TYPE,
		FSOURCE
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{PHASETEMPLATE_ID},	
		#{RUNTYPE},	
		#{FMANAGER},	
		#{PLAN_START_TIME},	
		#{PLAN_END_TIME},	
		#{PLAN_HOURS},	
		#{FTYPE},	
		#{YL1},	
		#{YL2},	
		#{YL3},	
		#{YL4},	
		#{YL5},	
		#{VISIABLE},	
		#{DEPPLAN_ID},
		#{FHTNAME},
		#{FHTLEVEL},
		#{PRO_PLAN_ID},
		#{ETYPE},
		#{NEW_PLAN_START_TIME},
		#{NEW_PLAN_END_TIME},
		#{REAL_SATRT_TIME},
		#{REAL_END_TIME},
		#{NOW_PLAN_TYPE},
		#{FSOURCE}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field2"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			DEPPLAN_ID = #{DEPPLAN_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			PHASETEMPLATE_ID = #{PHASETEMPLATE_ID},
			RUNTYPE = #{RUNTYPE},
			FMANAGER = #{FMANAGER},
			PLAN_START_TIME = #{PLAN_START_TIME},
			PLAN_END_TIME = #{PLAN_END_TIME},
			NEW_PLAN_START_TIME = #{NEW_PLAN_START_TIME},
			NEW_PLAN_END_TIME = #{NEW_PLAN_END_TIME},
			PLAN_HOURS = #{PLAN_HOURS},
			FTYPE = #{FTYPE},
			YL1 = #{YL1},
			YL2 = #{YL2},
			YL3 = #{YL3},
			YL4 = #{YL4},
			YL5 = #{YL5},
			DEPPLAN_ID = DEPPLAN_ID,
			FHTNAME = #{FHTNAME},
			FHTLEVEL = #{FHTLEVEL}
		where 
			DEPPLAN_ID = #{DEPPLAN_ID}
	</update>
	<!-- 修改 -->
	<update id="goXiafa" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			FTYPE = '已下发'
		where 1=1 
		<if test="DEPPLAN_ID != null and DEPPLAN_ID != ''">
			and DEPPLAN_ID = #{DEPPLAN_ID}
		</if>
	</update>
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		<include refid="Field"></include>,
isnull(f4.PPROJECT_CODE,'') PPROJECT_CODE,
isnull(f4.PPROJECT_NAME,'') PPROJECT_NAME,
isnull(f7.ECUSTOMER_NAME,'') ECUSTOMER_NAME,
isnull(f7.EEQM_NO,'') EEQM_NO,
isnull(f7.EEQM_NAME,'') EEQM_NAME,
isnull(f7.ETYPE,'') ETYPEX,
isnull(f7.EDELIVERY_DATE,'') EDELIVERY_DATE


		from 
		<include refid="tableName"></include> f
		left join 
		DT_PRO_PLAN f6 
		on f.PRO_PLAN_ID = f6.PRO_PLAN_ID 
		LEFT JOIN DT_PROJECT f4 
		ON f6.PROJECT_ID = f4.PROJECT_ID
		LEFT JOIN DT_EQUIPMENT f7
		ON f6.EQUIPMENT_ID = f7.EQUIPMENT_ID
		where 
			f.DEPPLAN_ID = #{DEPPLAN_ID}
	</select>
	<select id="datalistPageDep" parameterType="page" resultType="pd">
		SELECT
			c.EPROJECT_CODE,
			c.EPROJECT_NAME,
			c.EPROJECT_MANAGER,
			c.EPROJECT_PRINCIPAL,
			c.EEQM_NO,
			c.EEQM_NAME,
			c.EENGINEER_DESIGN,
			c.EELECTRIC_DESIGN,
			g.NAME FDEPT,
			b.PPROJECT_CODE,
			b.PPROJECT_NAME,
			isnull(f.DPACTUAL_HOUR,0.00) diffHour,
			f.* 
		FROM
			DT_PRO_PLAN a
			LEFT JOIN DT_PROJECT b ON a.PROJECT_ID = b.PROJECT_ID
			LEFT JOIN DT_EQUIPMENT c ON a.EQUIPMENT_ID = c.EQUIPMENT_ID
			LEFT JOIN DT_DEPPLAN f ON a.PRO_PLAN_ID = f.PRO_PLAN_ID 
			LEFT JOIN OA_DEPARTMENT g ON f.YL5 = g.DEPARTMENT_ID
		WHERE
			f.FTYPE = '已下发' 
			<if test="pd.ISALL== 'NO'.toString()">
			<if test="pd.ISBZ== 'NO'.toString()">
			
			</if>
			<if test="pd.ISBZ== 'YES'.toString()">
			 and f.YL5 = #{pd.DEPARTMENT_ID}   
			</if>
		</if>
			<if test="pd.HEQUIPMENT_ID != null and pd.HEQUIPMENT_ID != ''">
			and
				(
					c.EQUIPMENT_ID =#{pd.HEQUIPMENT_ID}
				)
			</if>
			<if test="pd.FTYPE != null and pd.FTYPE == 'FTYPE2' and pd.FTEXT == '完成' ">
			and
				(
					RUNTYPE =#{pd.FTEXT}
				)
			</if>
			<if test="pd.FTYPE != null and pd.FTYPE == 'FTYPE2' and pd.FTEXT == '未完成' ">
			and
				(
					RUNTYPE !='完成'
				)
			</if>
			<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 阶段名称检索 -->
			and
				(
					f.FHTNAME LIKE '%'+ #{pd.KEYWORDS}+'%'
				)
		</if>
			<if test="pd.KEYWORDS1 != null and pd.KEYWORDS1 != ''"><!-- 项目编号检索 -->
			and
				(
					b.PPROJECT_CODE LIKE '%'+ #{pd.KEYWORDS1}+'%'
				)
		</if>
		<if test="pd.KEYWORDS2 != null and pd.KEYWORDS2 != ''"><!-- 项目名称检索 -->
			and
				(
					b.PPROJECT_NAME LIKE '%'+ #{pd.KEYWORDS2}+'%'
				)
		</if>
		<if test="pd.KEYWORDS3 != null and pd.KEYWORDS3 != ''"><!-- 设备号和设备名称检索 -->
			and
				(
				c.EEQM_NO LIKE '%'+ #{pd.KEYWORDS3}+'%'
				)
		</if>
		<if test="pd.KEYWORDS4 != null and pd.KEYWORDS4 != ''"><!-- 设备名称检索 -->
			and
				(
				c.EEQM_NAME LIKE '%'+ #{pd.KEYWORDS4}+'%'
				)
		</if>
		<if test="pd.KEYWORDS5 != null and pd.KEYWORDS5 != ''"><!-- 设备状态检索 -->
			and
				(
				f.FTYPE LIKE '%'+ #{pd.KEYWORDS5}+'%'
				)
		</if>
		
		[fhstart]  ORDER BY b.PPROJECT_CODE,cast(isnull(FHTLEVEL,0) as int) [fhend]
	</select>

	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f 
		left join EPM_PHASETEMPLATE e 
		on f.PHASETEMPLATE_ID = e.PHASETEMPLATE_ID
		where 1=1 and f.VISIABLE = '1' and f.PRO_PLAN_ID = #{pd.PRO_PLAN_ID} 
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
				(
				<!--	根据需求自己加检索条件
					字段1 LIKE '%'+ #{pd.KEYWORDS}+'%'
					 or 
					字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' 
				-->
				)
		</if>
		[fhstart] order by cast(isnull(FHTLEVEL,0) as int)  [fhend]
	</select>
		<!-- 列表 -->
	<select id="listx" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f 
		left join EPM_PHASETEMPLATE e 
		on f.PHASETEMPLATE_ID = e.PHASETEMPLATE_ID
		where 1=1 and f.VISIABLE = '1' and f.PRO_PLAN_ID = #{PRO_PLAN_ID} 
		<if test="KEYWORDS != null and KEYWORDS != ''"><!-- 关键词检索 -->
			and
				(
				<!--	根据需求自己加检索条件
					字段1 LIKE '%'+ #{pd.KEYWORDS}+'%'
					 or 
					字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' 
				-->
				)
		</if>
		order by cast(isnull(f.FHTLEVEL,0) as int) 
	</select>
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include> f
		where 1=1 and f.VISIABLE = '1'
		<if test="PRO_PLAN_ID != null and PRO_PLAN_ID != ''">
			and PRO_PLAN_ID = #{PRO_PLAN_ID}
		</if>
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			DEPPLAN_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	<select id="getStartTime" parameterType="pd" resultType="pd">
		select top 1 isnull(PLAN_START_TIME,'') PLAN_START_TIME from <include refid="tableName"></include> 
		where PRO_PLAN_ID = #{PRO_PLAN_ID} and PLAN_START_TIME &lt; &gt; ''
		order by PLAN_START_TIME 
	</select>
	<select id="getEndTime" parameterType="pd" resultType="pd">
		select top 1 isnull(PLAN_END_TIME,'') PLAN_END_TIME from <include refid="tableName"></include> 
			where PRO_PLAN_ID = #{PRO_PLAN_ID}
		order by PLAN_END_TIME desc
	</select>
	<update id="updateType" parameterType="pd">
		update <include refid="tableName"></include>
		set ETYPE = #{ETYPE}
		where DEPPLAN_ID = #{DEPPLAN_ID}
	</update>
	
	<select id="getPlanTime" parameterType="pd" resultType="pd">
		select PLAN_START_TIME,PLAN_END_TIME from <include refid="tableName"></include>
		where DEPPLAN_ID = #{DEPPLAN_ID}
	</select>
	<update id="updateTime" parameterType="pd">
		update
		<include refid="tableName"></include>
		 set 
		PLAN_START_TIME = #{PLAN_START_TIME},
		PLAN_END_TIME = #{PLAN_END_TIME},
		NEW_PLAN_START_TIME = #{NEW_PLAN_START_TIME},
		NEW_PLAN_END_TIME = #{NEW_PLAN_END_TIME}
		where  DEPPLAN_ID = #{DEPPLAN_ID}
	</update>
	<!-- 项目计划部门反馈列表 -->
	<select id="datalistPageFeedBack" parameterType="page" resultType="pd">
		SELECT 
		isnull(a.DEPPLAN_ID,'') DEPPLAN_ID,
		isnull(d.PPROJECT_CODE,'') PPROJECT_CODE,
		isnull(d.PPROJECT_NAME,'') PPROJECT_NAME,
		isnull(c.EEQM_NO,'') EEQM_NO,
		isnull(c.EEQM_NAME,'') EEQM_NAME,
		isnull(a.FHTNAME,'') FHTNAME,
		isnull(a.FMANAGER,'') FMANAGER,
		isnull(a.NEW_PLAN_START_TIME,'') NEW_PLAN_START_TIME,
		isnull(a.NEW_PLAN_END_TIME,'') NEW_PLAN_END_TIME,
		isnull(a.REAL_SATRT_TIME,'') REAL_SATRT_TIME,
		isnull(a.REAL_END_TIME,'') REAL_END_TIME,
		isnull(a.RUNTYPE,'') RUNTYPE,
		isnull(a.NOW_PLAN_TYPE,'') NOW_PLAN_TYPE,
		a.FHTLEVEL
		FROM DT_DEPPLAN a LEFT JOIN DT_PRO_PLAN b ON a.PRO_PLAN_ID = b.PRO_PLAN_ID
		LEFT JOIN DT_EQUIPMENT c ON b.EQUIPMENT_ID = c.EQUIPMENT_ID
		LEFT JOIN DT_PROJECT d ON c.EPROJECT_ID = d.PROJECT_ID
		WHERE a.VISIABLE = '1' AND b.VISIABLE = '1' AND c.EVISIBLE = '1' AND d.PVISIBLE = '1'
		AND a.FTYPE = '已下发'
		AND a.YL5 = #{pd.DEPARTMENT_ID}
		<if test="pd.KEYWORDS1 != null and pd.KEYWORDS1 != ''"><!-- 关键词检索 -->
			AND d.PPROJECT_CODE = #{pd.KEYWORDS1}
		</if>
		<if test="pd.KEYWORDS2 != null and pd.KEYWORDS2 != ''"><!-- 关键词检索 -->
			AND d.PPROJECT_NAME LIKE '%' + #{pd.KEYWORDS2} + '%'
		</if>
		<if test="pd.KEYWORDS3 != null and pd.KEYWORDS3 != ''"><!-- 关键词检索 -->
			AND c.EEQM_NO = #{pd.KEYWORDS3}
		</if>
		<if test="pd.KEYWORDS4 != null and pd.KEYWORDS4 != ''"><!-- 关键词检索 -->
			AND c.EEQM_NAME LIKE '%' +  #{pd.KEYWORDS4} + '%'
		</if>
		<if test="pd.KEYTYPE != null and pd.KEYTYPE != ''"><!-- 关键词检索 -->
			AND a.RUNTYPE = #{pd.KEYTYPE}
		</if>
		[fhstart] order by PPROJECT_CODE,EEQM_NO,cast(isnull(FHTLEVEL,0) as int)  [fhend]
	</select>
	<!-- 项目计划部门反馈列表-excel导出 -->
	<select id="excelFeedBack" parameterType="pd" resultType="pd">
		SELECT 
		isnull(a.DEPPLAN_ID,'') DEPPLAN_ID,
		isnull(d.PPROJECT_CODE,'') PPROJECT_CODE,
		isnull(d.PPROJECT_NAME,'') PPROJECT_NAME,
		isnull(c.EEQM_NO,'') EEQM_NO,
		isnull(c.EEQM_NAME,'') EEQM_NAME,
		isnull(a.FHTNAME,'') FHTNAME,
		isnull(a.FMANAGER,'') FMANAGER,
		isnull(a.NEW_PLAN_START_TIME,'') NEW_PLAN_START_TIME,
		isnull(a.NEW_PLAN_END_TIME,'') NEW_PLAN_END_TIME,
		isnull(a.REAL_SATRT_TIME,'') REAL_SATRT_TIME,
		isnull(a.REAL_END_TIME,'') REAL_END_TIME,
		isnull(a.RUNTYPE,'') RUNTYPE,
		isnull(a.NOW_PLAN_TYPE,'') NOW_PLAN_TYPE,
		a.FHTLEVEL
		FROM DT_DEPPLAN a LEFT JOIN DT_PRO_PLAN b ON a.PRO_PLAN_ID = b.PRO_PLAN_ID
		LEFT JOIN DT_EQUIPMENT c ON b.EQUIPMENT_ID = c.EQUIPMENT_ID
		LEFT JOIN DT_PROJECT d ON c.EPROJECT_ID = d.PROJECT_ID
		WHERE a.VISIABLE = '1' AND b.VISIABLE = '1' AND c.EVISIBLE = '1' AND d.PVISIBLE = '1'
		AND a.FTYPE = '已下发'
		AND a.YL5 = #{DEPARTMENT_ID}
		<if test="KEYWORDS1 != null and KEYWORDS1 != ''"><!-- 关键词检索 -->
			AND d.PPROJECT_CODE = #{KEYWORDS1}
		</if>
		<if test="KEYWORDS2 != null and KEYWORDS2 != ''"><!-- 关键词检索 -->
			AND d.PPROJECT_NAME LIKE '%' + #{KEYWORDS2} + '%'
		</if>
		<if test="KEYWORDS3 != null and KEYWORDS3 != ''"><!-- 关键词检索 -->
			AND c.EEQM_NO = #{KEYWORDS3}
		</if>
		<if test="KEYWORDS4 != null and KEYWORDS4 != ''"><!-- 关键词检索 -->
			AND c.EEQM_NAME LIKE '%' +  #{KEYWORDS4} + '%'
		</if>
		<if test="KEYTYPE != null and KEYTYPE != ''"><!-- 关键词检索 -->
			AND a.RUNTYPE = #{KEYTYPE}
		</if>
		 order by PPROJECT_CODE,EEQM_NO,cast(isnull(FHTLEVEL,0) as int)  
	</select>
	<select id="findDept" parameterType="pd" resultType="pd">
		select a.DEPARTMENT_ID,b.NAME FDEPTNAME from OA_STAFF a
		LEFT JOIN OA_DEPARTMENT b ON a.DEPARTMENT_ID = b.DEPARTMENT_ID
		where a.NAME = #{NAME}
	</select>
	<select id="listDepDeisgnlistPage" parameterType="page" resultType="pd">
		SELECT
			b.PPROJECT_CODE,
			b.PPROJECT_NAME,
			b.PPROJECT_MANAGER,
			b.PPROJECT_PRINCIPAL,
			c.EEQM_NO,
			c.EEQM_NAME,
			g.NAME FDEPT,
			datediff(HOUR,f.REAL_SATRT_TIME,f.REAL_END_TIME) diffHour,
			f.* 
		FROM
			DT_PRO_PLAN a
			LEFT JOIN DT_PROJECT b ON a.PROJECT_ID = b.PROJECT_ID
			LEFT JOIN DT_EQUIPMENT c ON a.EQUIPMENT_ID = c.EQUIPMENT_ID
			LEFT JOIN DT_DEPPLAN f ON a.PRO_PLAN_ID = f.PRO_PLAN_ID 
			LEFT JOIN OA_DEPARTMENT g ON f.YL5 = g.DEPARTMENT_ID
		WHERE
			f.FTYPE = '已下发' 
			AND f.YL5  in('2b6af6c6257c4872aa4cb5cd3be2f973','b10125384d9e48c8a8a62b96bd53e05e')
			<if test="pd.HEQUIPMENT_ID != null and pd.HEQUIPMENT_ID != ''">
			and
				(
					c.EQUIPMENT_ID =#{pd.HEQUIPMENT_ID}
				)
			</if>
			<if test="pd.FTYPE != null and pd.FTYPE == 'FTYPE2' and pd.FTEXT == '完成' ">
			and
				(
					RUNTYPE =#{pd.FTEXT}
				)
			</if>
			<if test="pd.FTYPE != null and pd.FTYPE == 'FTYPE2' and pd.FTEXT == '未完成' ">
			and
				(
					RUNTYPE !='完成'
				)
			</if>
			<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 阶段名称检索 -->
			and
				(
					f.FHTNAME LIKE '%'+ #{pd.KEYWORDS}+'%'
				)
		</if>
			<if test="pd.KEYWORDS1 != null and pd.KEYWORDS1 != ''"><!-- 项目编号检索 -->
			and
				(
					b.PPROJECT_CODE LIKE '%'+ #{pd.KEYWORDS1}+'%'
				)
		</if>
		<if test="pd.KEYWORDS2 != null and pd.KEYWORDS2 != ''"><!-- 项目名称检索 -->
			and
				(
					b.PPROJECT_NAME LIKE '%'+ #{pd.KEYWORDS2}+'%'
				)
		</if>
		<if test="pd.KEYWORDS3 != null and pd.KEYWORDS3 != ''"><!-- 设备号和设备名称检索 -->
			and
				(
				c.EEQM_NO LIKE '%'+ #{pd.KEYWORDS3}+'%'
				)
		</if>
		<if test="pd.KEYWORDS4 != null and pd.KEYWORDS4 != ''"><!-- 设备名称检索 -->
			and
				(
				c.EEQM_NAME LIKE '%'+ #{pd.KEYWORDS4}+'%'
				)
		</if>
		<if test="pd.KEYWORDS5 != null and pd.KEYWORDS5 != ''"><!-- 设备状态检索 -->
			and
				(
				f.FTYPE LIKE '%'+ #{pd.KEYWORDS5}+'%'
				)
		</if>
		[fhstart]  ORDER BY b.PPROJECT_CODE,cast(isnull(FHTLEVEL,0) as int) [fhend]
	</select>
	<update id="deletex" parameterType="pd">
		update  
		<include refid="tableName"></include>
		set VISIABLE = '0'
		where 
			DEPPLAN_ID = #{DEPPLAN_ID}
	</update>
</mapper>