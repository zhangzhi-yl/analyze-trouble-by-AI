<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.ny.CollectionTwoMapper">

    <insert id="saveMultiRate" parameterType="list">
        insert into NY_MultiRate VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.time},
            #{item.tipPrice},
            #{item.tipValue},
            #{item.tipAmount},
            #{item.peakPrice},
            #{item.peakValue},
            #{item.peakAmount},
            #{item.flatPrice},
            #{item.flatValue},
            #{item.flatAmount},
            #{item.valleyPrice},
            #{item.valleyValue},
            #{item.valleyAmount},
            #{item.sumValue},
            #{item.sumAmount}
            )
        </foreach>
    </insert>
    <delete id="deleteAll">
        delete
        from NY_MultiRate
    </delete>
    <select id="getMultiRatedatalistPage" resultType="pd" parameterType="page">
        select f.*
        from NY_MultiRate f
            [fhstart]order by f.time DESC [fhend]
    </select>

    <!--    数据采集列表-->
    <select id="plcList" parameterType="pd" resultType="pd">
        SELECT f.SaveField,f.SaveTable,f.Extend1,f.Extend3 ParamAttribute,Loop
        FROM NY_PLC f
        WHERE 1=1
        <if test="IDS != null and IDS != ''"><!-- 关键词检索 -->
            and f.Loop IN ${IDS}
        </if>
        <if test="SaveTable != null and SaveTable != ''"><!-- 关键词检索 -->
            and f.SaveTable = #{SaveTable}
        </if>
        <if test="ParamType != null and ParamType != ''"><!-- 关键词检索 -->
            and f.ParamType like '%'+ #{ParamType}+'%'
        </if>
        <if test="AccParamType != null and AccParamType != ''"><!-- 关键词检索 -->
            and f.ParamType = #{AccParamType}
        </if>
        <if test="Loop_ID != null and Loop_ID != ''"><!-- 关键词检索 -->
            and f.Loop = #{Loop_ID}
        </if>
        <if test="isTotalUseEnergy != null and isTotalUseEnergy != ''"><!-- 关键词检索 -->
            and Loop IN (SELECT DM_SITE_ID FROM  MDM_SITE)
        </if>
    </select>
    <select id="plcdatalistPage" parameterType="page" resultType="pd">
        SELECT f.SaveField,f.SaveTable,f.Extend1,f.Extend3 ParamAttribute,Loop
        --         ,l.FCode FCode1,s.FCODE FCode2,a.FCODE FCode3
        ,l.FName DeptName1,s.FNAME DeptName2,a.FNAME DeptName3
        FROM NY_PLC f
        left join NY_Loop l on f.Loop = l.Loop_ID
        left join MDM_SITE s on f.Loop = s.DM_SITE_ID
        left join MDM_AREA a on f.Loop = a.AREA_ID
        WHERE 1=1
        <if test="pd.IDS != null and pd.IDS != ''"><!-- 关键词检索 -->
            and f.Loop IN ${pd.IDS}
        </if>
        <if test="pd.SaveTable != null and pd.SaveTable != ''"><!-- 关键词检索 -->
            and f.SaveTable = #{pd.SaveTable}
        </if>
        <if test="pd.AccParamType != null and pd.AccParamType != ''"><!-- 关键词检索 -->
            and f.ParamType = #{pd.AccParamType}
        </if>
        <if test="pd.Loop_ID != null and pd.Loop_ID != ''"><!-- 关键词检索 -->
            and f.Loop = #{pd.Loop_ID}
        </if>
    </select>

    <select id="monthMultiRate" parameterType="pd" resultType="pd">

        select a.day TimeStamp,isnull(b.value,0) value,DATEPART(DAY,a.day) day
        from
        (
        select day from(
        select convert(varchar(10),dateadd(DAY,t2.number,t1.day),120) day from
        (select #{date}+'-01' day) t1,
        (select number from MASTER..spt_values WHERE TYPE='P' AND number&gt;=0 and number&lt;=31) t2
        where convert(varchar(10),dateadd(DAY,t2.number,t1.day),120) like #{date} +'%'
        ) as d
        where d.day &lt;= CONVERT(varchar(100), GETDATE(), 23)
        ) a left join (
        select ${QueryField},SUBSTRING(f.TimeStamp, 0, 11) TimeStamp from T_PatraElectric f
        where 1=1
        <if test="startTime != null and startTime != ''"><!-- 关键词检索 -->
            and
            SUBSTRING(f.TimeStamp, 12, 5) &gt;= #{startTime}
        </if>
        <if test="endTime != null and endTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 12, 5) &lt;= #{endTime}
        </if>
        <if test="date != null and date != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 8) = #{date}
        </if>
        GROUP BY SUBSTRING(f.TimeStamp, 0, 11)

        <if test="startTimeBefore != null and startTimeBefore != ''"><!-- 关键词检索 -->
            UNION
            select ${QueryField},SUBSTRING(f.TimeStamp, 0, 11) TimeStamp from T_PatraElectric f
            where 1=1
            and
            SUBSTRING(f.TimeStamp, 12, 5) &gt;= #{startTimeBefore}
            <if test="endTimeBefore != null and endTimeBefore != ''"><!-- 关键词检索 -->
                and SUBSTRING(f.TimeStamp, 12, 5) &lt;= #{endTimeBefore}
            </if>
            <if test="date != null and date != ''"><!-- 关键词检索 -->
                and SUBSTRING(f.TimeStamp, 0, 8) = #{date}
            </if>
            GROUP BY SUBSTRING(f.TimeStamp, 0, 11)
        </if>
        ) b on a.day = b.TimeStamp

    </select>

    <select id="quarterMultiRate" parameterType="pd" resultType="pd">
        select DATENAME(YEAR,GETDATE())+'-'+CAST (a.day AS VARCHAR (5) ) TimeStamp,isnull(b.value,0) value,a.day
        from
        (
        select (${date} - 1) * 3 + 1 AS day union all
        select (${date} - 1) * 3 + 2 AS day union all
        select (${date} - 1) * 3 + 3 AS day
        ) as a left join (
        select ${QueryField},DATEPART(MM, f.TimeStamp) month,SUBSTRING(f.TimeStamp, 0, 8)  TimeStamp from T_PatraElectric f
        where 1=1
        <if test="startTime != null and startTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 12, 5) &gt;= #{startTime}
        </if>
        <if test="endTime != null and endTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 12, 5) &lt;= #{endTime}
        </if>
        <if test="date != null and date != ''"><!-- 关键词检索 -->
            and DATEPART(qq,f.TimeStamp) = #{date}
            <if test="year != null and year != ''"><!-- 关键词检索 -->
                and DATEPART(year,f.TimeStamp) = #{year}
            </if>
        </if>
        GROUP BY DATEPART(MM, f.TimeStamp),SUBSTRING(f.TimeStamp, 0, 8)
        ) b on a.day = b.month
    </select>

    <select id="yearMultiRate" parameterType="pd" resultType="pd">
        select a.day TimeStamp,isnull(b.value,0) value,a.day
        from
        (
        select day from(
        select convert(varchar(7),dateadd(mm,t.number,dateadd(year, datediff(year, 0, #{date}), 0)),120) day
        from
        (select number from master..spt_values where type='P'AND number&gt;=0 and number&lt;=12) t
        where year(dateadd(mm,t.number,dateadd(year, datediff(year, 0, #{date}), 0)))=year(#{date})
        ) as d
        where d.day &lt;= SUBSTRING(CONVERT(varchar(100), GETDATE(), 23),0,8)
        ) a left join (
        select ${QueryField},SUBSTRING(f.TimeStamp, 0, 8) TimeStamp from T_PatraElectric f
        where 1=1
        <if test="startTime != null and startTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 12, 5) &gt;= #{startTime}
        </if>
        <if test="endTime != null and endTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 12, 5) &lt;= #{endTime}
        </if>
        <if test="date != null and date != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 5) = #{date}
        </if>
        GROUP BY SUBSTRING(f.TimeStamp, 0, 8)
        ) b on a.day = b.TimeStamp
    </select>

    <select id="monitordatalistPage" parameterType="page" resultType="pd">
        SELECT ${pd.QueryField} , SUBSTRING (f.TimeStamp,12,5) TimeStamp
        FROM
            ${pd.SaveTable} f
        WHERE SUBSTRING (f.TimeStamp,0,11) = #{pd.date}
            [fhstart]ORDER BY f.TimeStamp DESC[fhend]
    </select>
    <select id="monitorAllList" parameterType="pd" resultType="pd">
        SELECT ${QueryField} , SUBSTRING (f.TimeStamp,12,5) TimeStamp
        FROM
            ${SaveTable} f
        WHERE SUBSTRING (f.TimeStamp,0,11) = #{date}
        ORDER BY f.TimeStamp ASC
    </select>

    <select id="lineLossList" parameterType="pd" resultType="pd">
        SELECT ${QueryField}
        FROM
        ${SaveTable} f
        WHERE 1=1
        <if test="startTime != null and startTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 11) &gt;= #{startTime}
        </if>
        <if test="endTime != null and endTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 11) &lt;= #{endTime}
        </if>
    </select>

    <select id="BigMultiRate" parameterType="pd" resultType="pd">
        SELECT ${QueryField}
        FROM
        T_PatraElectric f
        WHERE 1=1
        <if test="startTime != null and startTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 12, 5) &gt;= #{startTime}
        </if>
        <if test="endTime != null and endTime != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 12, 5) &lt; #{endTime}
        </if>
        <if test="date != null and date != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 11) = #{date}
        </if>

        <if test="startTimeBefore != null and startTimeBefore != ''"><!-- 关键词检索 -->
            UNION
            select ${QueryField} from T_PatraElectric f
            where 1=1
            and
            SUBSTRING(f.TimeStamp, 12, 5) &gt;= #{startTimeBefore}
            <if test="endTimeBefore != null and endTimeBefore != ''"><!-- 关键词检索 -->
                and SUBSTRING(f.TimeStamp, 12, 5) &lt; #{endTimeBefore}
            </if>
            <if test="date != null and date != ''"><!-- 关键词检索 -->
                and SUBSTRING(f.TimeStamp, 0, 11) = #{date}
            </if>
        </if>
    </select>

    <select id="useEnergyData" parameterType="pd" resultType="pd">
        SELECT ${QueryField}
        FROM
        ${SaveTable} f
        WHERE 1=1
        <if test="day != null and day != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 11) = #{day}
        </if>
        <if test="month != null and month != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 8) = #{month}
        </if>
        <if test="year != null and year != ''"><!-- 关键词检索 -->
            and SUBSTRING(f.TimeStamp, 0, 5) = #{year}
        </if>
        <if test="beforeDay != null and beforeDay != ''"><!-- 关键词检索 -->
            and f.TimeStamp &lt;= #{beforeDay} and f.TimeStamp &gt;= CONVERT(varchar(100), dateadd(day, -1, getdate()), 23)+' 00:00:00'
        </if>
    </select>

</mapper>