<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.mm.ExceptionHandlingMapper">
	
	<!--表名 -->
	<sql id="tableName">
		MM_ExceptionHandling
	</sql>
	
	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		f.FOperator,	
		f.Exception_ID,	
		f.WaitingOperatorID,	
		f.IfTurnOver,	
		f.TurnOverTime,	
		f.DisposeType,	
		f.FExplanation,	
		f.FOperatorID,	
		f.FTime,	
		f.FStatus,	
		f.Reorder,
		f.ExceptionHandling_ID
	</sql>
	
	<!-- 字段用于新增 -->
	<sql id="Field2">
		FOperator,	
		Exception_ID,	
		WaitingOperatorID,	
		IfTurnOver,	
		TurnOverTime,	
		DisposeType,	
		FExplanation,	
		FOperatorID,	
		FTime,	
		FStatus,	
		Reorder,
		ExceptionHandling_ID
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{FOperator},	
		#{Exception_ID},	
		#{WaitingOperatorID},	
		#{IfTurnOver},	
		#{TurnOverTime},	
		#{DisposeType},	
		#{FExplanation},	
		#{FOperatorID},	
		#{FTime},	
		#{FStatus},	
		#{Reorder},
		#{ExceptionHandling_ID}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field2"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			ExceptionHandling_ID = #{ExceptionHandling_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			DisposeType = #{DisposeType},
			FExplanation = #{FExplanation},
			FOperatorID = #{FOperatorID},
			FTime = #{FTime},
			FStatus = #{FStatus}
		where 
			ExceptionHandling_ID = #{ExceptionHandling_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		SELECT
			f.ExceptionHandling_ID,   												<!-- 主键ID -->
			f.Exception_ID,															<!-- 异常ID -->
			case when f.FOperator = 1 then '部门' else '人' end FOperator,           <!-- 初始处理人或部门 -->
			case when f.IfTurnOver = 1 then '是' else '否' end IfTurnOver,			<!-- 是否移交 -->
			isnull(a.NAME,'') WaitingOperatorIDStaff,                                			<!-- 初始处理人 -->
			isnull(b.NAME,'') WaitingOperatorIDDept,											<!-- 初始处理部门 -->
			f.TurnOverTime,															<!-- 移交时间 -->
			f.DisposeType,															<!-- 处理判别 -->
			f.FExplanation,															<!-- 处理描述 -->
			isnull(c.NAME,'') FOperatorID,                                                     <!-- 处理人 -->
			f.FTime,																<!-- 处理时间 -->
			f.FStatus,																<!-- 处理状态 -->
			f.Reorder																<!-- 记录排序 -->
		FROM
			MM_ExceptionHandling f
			LEFT JOIN OA_STAFF a on f.WaitingOperatorID = a.STAFF_ID
			LEFT JOIN OA_DEPARTMENT b on f.WaitingOperatorID = b.DEPARTMENT_ID
			LEFT JOIN OA_STAFF c on f.FOperatorID = c.STAFF_ID
		where 
			f.ExceptionHandling_ID = #{ExceptionHandling_ID}
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		SELECT
			f.ExceptionHandling_ID,   												<!-- 主键ID -->
			f.Exception_ID,															<!-- 异常ID -->
			case when f.FOperator = 1 then '部门' else '人' end FOperator,           <!-- 初始处理人或部门 -->
			case when f.IfTurnOver = 1 then '是' else '否' end IfTurnOver,			<!-- 是否移交 -->
			isnull(a.NAME,'') WaitingOperatorIDStaff,                               <!-- 初始处理人 -->
			isnull(b.NAME,'') WaitingOperatorIDDept,								<!-- 初始处理部门 -->
			f.TurnOverTime,															<!-- 移交时间 -->
			f.DisposeType,															<!-- 处理判别 -->
			f.FExplanation,															<!-- 处理描述 -->
			isnull(c.NAME,'') FOperatorID,                                          <!-- 处理人 -->
			f.FTime,																<!-- 处理时间 -->
			f.FStatus,																<!-- 处理状态 -->
			f.Reorder																<!-- 记录排序 -->
		FROM
			MM_ExceptionHandling f
			LEFT JOIN OA_STAFF a on f.WaitingOperatorID = a.STAFF_ID
			LEFT JOIN OA_DEPARTMENT b on f.WaitingOperatorID = b.DEPARTMENT_ID
			LEFT JOIN OA_STAFF c on f.FOperatorID = c.STAFF_ID
		where 1=1 and f.Exception_ID = #{pd.Exception_ID}
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
				(
				<!--	根据需求自己加检索条件
					字段1 LIKE '%'+ #{pd.KEYWORDS}+'%'
					 or 
					字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' 
				-->
				)
		</if>
		[fhstart]order by f.Reorder[fhend]
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		SELECT
			f.ExceptionHandling_ID,   												<!-- 主键ID -->
			f.Exception_ID,															<!-- 异常ID -->
			case when f.FOperator = 1 then '部门' else '人' end FOperator,           <!-- 初始处理人或部门 -->
			case when f.IfTurnOver = 1 then '是' else '否' end IfTurnOver,			<!-- 是否移交 -->
			isnull(a.NAME,'') WaitingOperatorIDStaff,                                <!-- 初始处理人 -->
			isnull(b.NAME,'') WaitingOperatorIDDept,								<!-- 初始处理部门 -->
			f.TurnOverTime,															<!-- 移交时间 -->
			f.DisposeType,															<!-- 处理判别 -->
			f.FExplanation,															<!-- 处理描述 -->
			isnull(c.NAME,'') FOperatorID,                                                     <!-- 处理人 -->
			f.FTime,																<!-- 处理时间 -->
			f.FStatus,																<!-- 处理状态 -->
			f.Reorder																	<!-- 记录排序 -->
		FROM
			MM_ExceptionHandling f
			LEFT JOIN OA_STAFF a on f.WaitingOperatorID = a.STAFF_ID
			LEFT JOIN OA_DEPARTMENT b on f.WaitingOperatorID = b.DEPARTMENT_ID
			LEFT JOIN OA_STAFF c on f.FOperatorID = c.STAFF_ID
		where 1=1 and f.Exception_ID = #{Exception_ID}
		order by f.Reorder
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			ExceptionHandling_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	<!-- 修改异常处理记录的异常判别状态 -->
	<update id="EditDisposeType" parameterType="pd">
		update
			<include refid="tableName"></include>
		set
			DisposeType = '移交处理',
			IfTurnOver = 1,
			TurnOverTime = #{TurnOverTime},
			FOperatorID = #{FOperatorID},
			FTime = #{FTime}
		where
			ExceptionHandling_ID = #{ExceptionHandling_ID}
	</update>
	<!-- 异常处理完成,修改异常判别状态为已处理 -->
	<update id="FinishException" parameterType="pd">
		update
			<include refid="tableName"></include>
		set
			FStatus = '已处理',
			DisposeType = '已处理',
			FOperatorID = #{FOperatorID},
			FTime = #{FTime}
		where
			ExceptionHandling_ID = #{ExceptionHandling_ID}
	</update>
	<!-- 获取该异常下最后一条异常记录，该字段的最大值 -->
	<select id="getReorder" parameterType="pd" resultType="pd">
		select 
			top 1 Reorder 
		from 
			<include refid="tableName"></include>
		where 
			Exception_ID = #{Exception_ID}
		order by Reorder desc
	</select>
	<select id="AppList" parameterType="org.yy.controller.app.AppPage" resultType="pd">
		SELECT
			f.ExceptionHandling_ID,   												<!-- 主键ID -->
			f.Exception_ID,															<!-- 异常ID -->
			case when f.FOperator = 1 then '部门' else '人' end FOperator,           <!-- 初始处理人或部门 -->
			case when f.IfTurnOver = 1 then '是' else '否' end IfTurnOver,			<!-- 是否移交 -->
			isnull(a.NAME,'') WaitingOperatorIDStaff,                               <!-- 初始处理人 -->
			isnull(b.NAME,'') WaitingOperatorIDDept,								<!-- 初始处理部门 -->
			f.TurnOverTime,															<!-- 移交时间 -->
			f.DisposeType,															<!-- 处理判别 -->
			f.FExplanation,															<!-- 处理描述 -->
			isnull(c.NAME,'') FOperatorID,                                          <!-- 处理人 -->
			f.FTime,																<!-- 处理时间 -->
			f.FStatus,																<!-- 处理状态 -->
			f.Reorder																<!-- 记录排序 -->
		FROM
			MM_ExceptionHandling f
			LEFT JOIN OA_STAFF a on f.WaitingOperatorID = a.STAFF_ID
			LEFT JOIN OA_DEPARTMENT b on f.WaitingOperatorID = b.DEPARTMENT_ID
			LEFT JOIN OA_STAFF c on f.FOperatorID = c.STAFF_ID
		where 1=1 and f.Exception_ID = #{pd.Exception_ID}
	</select>
	<!-- yy356703572qq(彬耶) -->
</mapper>