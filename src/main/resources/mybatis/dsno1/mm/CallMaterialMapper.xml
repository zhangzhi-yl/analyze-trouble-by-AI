<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.mm.CallMaterialMapper">

	<!--表名 -->
	<sql id="tableName">
		MM_CallMaterial
	</sql>

	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>

	<!-- 字段 -->
	<sql id="Field">

		f.DocumentNum,
		f.NeedUseTime,
		f.SaleOrderNum,
		f.PlanningWorkOrderNum,
		f.PlanningWorkOrderMasterNum,
		f.TaskNum,
		f.WokNum,
		f.MakePersonID,
		f.MakeTime,
		f.FState,
		f.CallMaterial_ID,
		f.Associated_ID,
		f.FCallTime,
		f.FCallMan,
		f.FOutTime,
		f.FOutMan,
		f.FInTime,
		f.FInMan,
		f.FRecieveTime,
		f.FRecieveMan
	</sql>

	<!-- 字段用于新增 -->
	<sql id="Field2">

		DocumentNum,
		NeedUseTime,
		SaleOrderNum,
		PlanningWorkOrderNum,
		PlanningWorkOrderMasterNum,
		TaskNum,
		WokNum,
		MakePersonID,
		MakeTime,
		FState,
		CallMaterial_ID,
		Associated_ID,
		FCallTime,
		FCallMan,
		FOutTime,
		FOutMan,
		FInTime,
		FInMan,
		FRecieveTime,
		FRecieveMan
	</sql>

	<!-- 字段值 -->
	<sql id="FieldValue">

		#{DocumentNum},
		#{NeedUseTime},
		#{SaleOrderNum},
		#{PlanningWorkOrderNum},
		#{PlanningWorkOrderMasterNum},
		#{TaskNum},
		#{WokNum},
		#{MakePersonID},
		#{MakeTime},
		#{FState},
		#{CallMaterial_ID},
		#{Associated_ID},
		#{FCallTime},
		#{FCallMan},
		#{FOutTime},
		#{FOutMan},
		#{FInTime},
		#{FInMan},
		#{FRecieveTime},
		#{FRecieveMan}
	</sql>

	<!-- 新增 -->
	<insert id="save" parameterType="pd">
		insert into
		<include refid="tableName"></include>
		(
		<include refid="Field2"></include>
		) values (
		<include refid="FieldValue"></include>
		)
	</insert>

	<!-- 删除 -->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where
		CallMaterial_ID = #{CallMaterial_ID}
	</delete>

	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set

		DocumentNum = #{DocumentNum},
		NeedUseTime = #{NeedUseTime},
		SaleOrderNum = #{SaleOrderNum},
		PlanningWorkOrderNum = #{PlanningWorkOrderNum},
		PlanningWorkOrderMasterNum = #{PlanningWorkOrderMasterNum},
		TaskNum = #{TaskNum},
		WokNum = #{WokNum},
		MakePersonID = #{MakePersonID},
		MakeTime = #{MakeTime},
		FState = #{FState},
		FCallTime=#{FCallTime},
		FCallMan=#{FCallMan},
		FOutTime=#{FOutTime},
		FOutMan=#{FOutMan},
		FInTime=#{FInTime},
		FInMan=#{FInMan},
		FRecieveTime=#{FRecieveTime},
		FRecieveMan=#{FRecieveMan},
		CallMaterial_ID = CallMaterial_ID
		where
		CallMaterial_ID = #{CallMaterial_ID}
	</update>

	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		f
		where
		f.CallMaterial_ID = #{CallMaterial_ID}
	</select>

	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>,
		(select count(*) FNUM from(
select Material_ID,DemandNum-QuantityCount DemandNum,DemandNum-QuantityCount QuantityCount from(select Material_ID,
 sum(cast(isnull(DemandNum,0) as NUMERIC(24,2)))/count(*) DemandNum,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2))) QuantityCount
from(
select 
 Material_ID,sum(cast(isnull(DemandNum,0) as NUMERIC(24,2))) DemandNum,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2))) QuantityCount
 from MM_CallMaterialDetails where CallMaterial_ID=f.CallMaterial_ID group by Material_ID
union ALL
select 
 Material_ID,0,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2)))
 from MM_CallMaterialDetails a
 inner join MM_CallMaterial b on a.CallMaterial_ID=b.CallMaterial_ID
where b.Associated_ID=f.CallMaterial_ID group by Material_ID
) gy 

group by Material_ID
) gy1
where DemandNum > QuantityCount
) gy2) FNUM,
(select 
 count(*) 
 from MM_CallMaterial b 
where b.Associated_ID=f.CallMaterial_ID) FNUM1
		from
		<include refid="tableName"></include>
		f
		where 1=1
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			<!-- 根据需求自己加检索条件 字段1 LIKE '%'+ #{pd.KEYWORDS}+'%' or 字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' -->
			)
		</if>
		<if test="pd.DocumentNum !=null  and pd.DocumentNum != ''  ">
			and
			f.DocumentNum like '%'+#{pd.DocumentNum} + '%'
		</if>
		<if test="pd.FState !=null  and pd.FState != ''  ">
			and f.FState =
			#{pd.FState}
		</if>
		<if test="pd.MakePersonID !=null  and pd.MakePersonID != ''  ">
			and
			f.MakePersonID = #{pd.MakePersonID}
		</if>
		[fhstart] order by DocumentNum desc [fhend]
	</select>

	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		f
	</select>

	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where
		CallMaterial_ID in
		<foreach item="item" index="index" collection="array" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</delete>
	<!-- 列表 -->
	<select id="chejiandatalistPage" parameterType="page"
		resultType="pd">
		select
		<include refid="Field"></include>,
case when (Associated_ID is null or Associated_ID='') then (select count(*) FNUM from(
select Material_ID,DemandNum-QuantityCount DemandNum,DemandNum-QuantityCount QuantityCount from(select Material_ID,
 sum(cast(isnull(DemandNum,0) as NUMERIC(24,2)))/count(*) DemandNum,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2))) QuantityCount
from(
select 
 Material_ID,sum(cast(isnull(DemandNum,0) as NUMERIC(24,2))) DemandNum,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2))) QuantityCount
 from MM_CallMaterialDetails where CallMaterial_ID=f.CallMaterial_ID group by Material_ID
union ALL
select 
 Material_ID,0,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2)))
 from MM_CallMaterialDetails a
 inner join MM_CallMaterial b on a.CallMaterial_ID=b.CallMaterial_ID
where b.Associated_ID=f.CallMaterial_ID group by Material_ID
) gy 

group by Material_ID
) gy1
where DemandNum > QuantityCount
) gy2)  else '0' end  FNUM,
case when (Associated_ID is null or Associated_ID='') then (select 
 count(*) 
 from MM_CallMaterial b 
where b.Associated_ID=f.CallMaterial_ID) else '0' end  FNUM1
		
		from
		<include refid="tableName"></include>
		f
		where 1=1
		and f.FState in ('新增','仓库出库','车间入库')
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			<!-- 根据需求自己加检索条件 字段1 LIKE '%'+ #{pd.KEYWORDS}+'%' or 字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' -->
			)
		</if>
		<if test="pd.DocumentNum !=null  and pd.DocumentNum != ''  ">
			and
			f.DocumentNum like '%'+#{pd.DocumentNum} + '%'
		</if>
		<if test="pd.FState !=null  and pd.FState != ''  ">
			and f.FState =
			#{pd.FState}
		</if>
		<if test="pd.MakePersonID !=null  and pd.MakePersonID != ''  ">
			and
			f.MakePersonID = #{pd.MakePersonID}
		</if>
		[fhstart] order by DocumentNum desc [fhend]
	</select>
	<!-- 列表 -->
	<select id="kufangdatalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		f
		where 1=1
		and f.FState in ('叫料','仓库接收')
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			<!-- 根据需求自己加检索条件 字段1 LIKE '%'+ #{pd.KEYWORDS}+'%' or 字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' -->
			)
		</if>
		<if test="pd.DocumentNum !=null  and pd.DocumentNum != ''  ">
			and
			f.DocumentNum like '%'+#{pd.DocumentNum} + '%'
		</if>
		<if test="pd.FState !=null  and pd.FState != ''  ">
			and f.FState =
			#{pd.FState}
		</if>
		<if test="pd.MakePersonID !=null  and pd.MakePersonID != ''  ">
			and
			f.MakePersonID = #{pd.MakePersonID}
		</if>
		[fhstart] order by DocumentNum desc [fhend]
	</select>
	<select id="listchejianApp" parameterType="org.yy.controller.app.AppPage"
		resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		f
		where 1=1
		and f.FState in ('仓库出库','车间入库')
		
		<if test="pd.DocumentNum !=null  and pd.DocumentNum != ''  ">
			and
			f.DocumentNum like '%'+#{pd.DocumentNum} + '%'
		</if>
		<if test="pd.FState !=null  and pd.FState != ''  ">
			and f.FState =
			#{pd.FState}
		</if>
		<if test="pd.MakePersonID !=null  and pd.MakePersonID != ''  ">
			and
			f.MakePersonID = #{pd.MakePersonID}
		</if>
	</select>
	<select id="listkufangApp" parameterType="org.yy.controller.app.AppPage"
		resultType="pd">
		select
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		f
		where 1=1
		and f.FState in ('叫料','仓库接收')
		<if test="pd.DocumentNum !=null  and pd.DocumentNum != ''  ">
			and
			f.DocumentNum like '%'+#{pd.DocumentNum} + '%'
		</if>
		<if test="pd.FState !=null  and pd.FState != ''  ">
			and f.FState =
			#{pd.FState}
		</if>
		<if test="pd.MakePersonID !=null  and pd.MakePersonID != ''  ">
			and
			f.MakePersonID = #{pd.MakePersonID}
		</if>
	</select>
	
	<select id="getCallMaterialDataByMasterPlanningWorkNum" parameterType="pd" resultType="pd">
		SELECT
				MaterialID Material_ID,
				isnull(mat.MAT_NAME, '无名称') MaterialName,
				isnull(mat.MAT_CODE, '无名称') MaterialCode,
				SUM (PlannedQuantity) AS DemandNum,
				isnull(
					unit.FNAME,
					'无单位名称'
				) FUnitName,
			isnull(mat.MAT_SPECS, '默认规格') Specification
		FROM
			PP_WorkorderProcessIOExample pwioe
		LEFT JOIN MBASE_MAT_BASIC mat ON mat.MAT_BASIC_ID = pwioe.MaterialID
		LEFT JOIN MBASE_UNIT_INFO unit ON mat.MAT_MAIN_UNIT = unit.UNIT_INFO_ID
		LEFT JOIN MBASE_MAT_CLASS claz on claz.MAT_CLASS_ID = mat.MAT_CLASS_ID
		WHERE
			pwioe.ProcessWorkOrderExampleID IN (
				SELECT
					pwoe.ProcessWorkOrderExample_ID
				FROM
					PP_ProcessWorkOrderExample pwoe
				LEFT JOIN km_WorkingProcedureExample wpe ON wpe.WorkingProcedureExample_ID = pwoe.WorkingProcedureExampleID
				WHERE
					pwoe.PlanningWorkOrderID IN (
						SELECT
							PlanningWorkOrder_ID
						FROM
							PP_PlanningWorkOrder
						WHERE 1=1
							
							
							<if test="MasterWorkOrderNum != null">
								and MasterWorkOrderNum IN 
								<foreach item="item" index="index" collection="MasterWorkOrderNum" open="("
									separator="," close=")">
									#{item}
								</foreach>
							</if>
							
					)
			)
		AND TType = '投入'
		and claz.FCLASS not in  ('中间品','半成品')
		GROUP BY
			pwioe.MaterialID,
			mat.MAT_NAME,
			mat.MAT_CODE,
			unit.FNAME,mat.MAT_SPECS
	</select>
	<!-- 多次叫料列表(全部) -->
	<select id="listAllMat" parameterType="pd" resultType="pd">
		select gy3.*,gy2.DemandNum DemandNumx,gy2.QuantityCount QuantityCountx from(
select Material_ID,DemandNum-QuantityCount DemandNum,DemandNum-QuantityCount QuantityCount from(select Material_ID,
 sum(cast(isnull(DemandNum,0) as NUMERIC(24,2))) DemandNum,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2))) QuantityCount
from(
select 
 Material_ID,sum(cast(isnull(DemandNum,0) as NUMERIC(24,2))) DemandNum,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2))) QuantityCount
 from MM_CallMaterialDetails where CallMaterial_ID=#{CallMaterial_ID} group by Material_ID
union ALL
select 
 Material_ID,0,
 sum(cast(isnull(QuantityCount,0) as NUMERIC(24,2)))
 from MM_CallMaterialDetails a
 inner join MM_CallMaterial b on a.CallMaterial_ID=b.CallMaterial_ID
where b.Associated_ID=#{CallMaterial_ID} group by Material_ID
) gy 

group by Material_ID
) gy1
where DemandNum > QuantityCount
) gy2
left join MM_CallMaterialDetails gy3 on (gy2.Material_ID=gy3.Material_ID and gy3.CallMaterial_ID=#{CallMaterial_ID})
	</select>
	
	<!-- 列表 -->
	<select id="listXMkufangdatalistPage" parameterType="page" resultType="pd">
		select
		f2.PPROJECT_CODE,f2.PPROJECT_NAME,
		<include refid="Field"></include>
		from
		<include refid="tableName"></include>
		f
		left join PMS_Cabinet_Assembly_Detail f1
		on f.PlanningWorkOrderNum=f1.Cabinet_No
		left join DT_PROJECT f2
		on f1.PROJECT_ID=f2.PROJECT_ID
		where 1=1
		and f.CallMaterial_ID in 
		(
select distinct f2.CallMaterial_ID from PP_PlanningWorkOrder f1 
inner join MM_CallMaterial f2 on f1.WorkOrderNum=f2.PlanningWorkOrderNum
inner join PMS_Cabinet_Assembly_Detail f3 on f1.WorkOrderNum =f3.Cabinet_No
inner join DT_PROJECT f4 on f3.PROJECT_ID =f4.PROJECT_ID
inner join PMS_Cabinet_Assembly f5 on f3.Cabinet_Assembly_ID = f5.Cabinet_Assembly_ID
where 1=1 and f2.FState='仓库接收' and f4.PPROJECT_MANAGER=#{pd.CREATORMAN} and f4.FEND_STATE !='结束'
)
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			<!-- 根据需求自己加检索条件 字段1 LIKE '%'+ #{pd.KEYWORDS}+'%' or 字段2 LIKE '%'+ #{pd.KEYWORDS}+'%' -->
			)
		</if>
		<if test="pd.DocumentNum !=null  and pd.DocumentNum != ''  ">
			and
			f.DocumentNum like '%'+#{pd.DocumentNum} + '%'
		</if>
		<if test="pd.FState !=null  and pd.FState != ''  ">
			and f.FState =
			#{pd.FState}
		</if>
		<if test="pd.MakePersonID !=null  and pd.MakePersonID != ''  ">
			and
			f.MakePersonID = #{pd.MakePersonID}
		</if>
		[fhstart] order by DocumentNum desc [fhend]
	</select>
</mapper>