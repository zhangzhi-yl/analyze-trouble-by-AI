<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.zm.EquipmentMapper">

	<!--表名 -->
	<sql id="tableName">
		ZM_EQUIPMENT
	</sql>

	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>

	<!-- 字段 -->
	<sql id="Field">
		f.FName,	
		f.FNumber,	
		f.FDept,	
		f.FStatus,	
		f.FCol,	
		f.FRow,	
		f.FModel,	
		f.Manufactor,	
		f.Remarks,	
		f.Location,	
		f.IfWarning,	
		f.Files,
		f.CreateTime,
		f.Creator,
		f.Loop,
		f.FType,
		f.EQUIPMENT_ID,
		f.IsHidden,
		f.FileOPEN,
		f.FileCLOSE,
		f.FFault,
		f.Workshop,
		f.January,
		f.February,
        f.March,
        f.April,
        f.May,
        f.June,
        f.July,
        f.August,
        f.September,
        f.October,
        f.November,
		f.December,
		f.alarmContent,
		f.alarmTime
	</sql>

	<!-- 字段用于新增 -->
	<sql id="Field2">
		FName,
		FNumber,
		FDept,
		FStatus,
		FCol,
		FRow,
		FModel,
		Manufactor,
		Remarks,
		Location,
		IfWarning,
		Files,
		CreateTime,
		Creator,
		Loop,
		FType,
		EQUIPMENT_ID,
		IsHidden,
		FileOPEN,
		FileCLOSE,
		FFault,
		Workshop,
	</sql>

	<!-- 字段值 -->
	<sql id="FieldValue">
		#{FName},
		#{FNumber},
		#{FDept},
		#{FStatus},
		#{FCol},
		#{FRow},
		#{FModel},
		#{Manufactor},
		#{Remarks},
		#{Location},
		#{IfWarning},
		#{Files},
		#{CreateTime},
		#{Creator},
		#{Loop},
		#{FType},
		#{EQUIPMENT_ID},
		#{IsHidden},
		#{FileOPEN},
		#{FileCLOSE},
		#{FFault},
		#{Workshop},
	</sql>

	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into
		<include refid="tableName"></include>
		(
		<include refid="Field2"></include>
		) values (
		<include refid="FieldValue"></include>
		)
	</insert>

	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where
		EQUIPMENT_ID = #{EQUIPMENT_ID}
	</delete>

	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set
		FName = #{FName},
		FNumber = #{FNumber},
		FDept = #{FDept},
		FStatus = #{FStatus},
		FCol = #{FCol},
		FRow = #{FRow},
		FModel = #{FModel},
		Manufactor = #{Manufactor},
		Remarks = #{Remarks},
		Location = #{Location},
		IfWarning = #{IfWarning},
		Files = #{Files},
		Loop = #{Loop},
		FType = #{FType},
		EQUIPMENT_ID = EQUIPMENT_ID,
		IsHidden= #{IsHidden},
		FileOPEN= #{FileOPEN},
		FileCLOSE= #{FileCLOSE},
		FFault=#{FFault}
		where
		EQUIPMENT_ID = #{EQUIPMENT_ID}
	</update>

	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>,l.Loop_ID LOOP_ID,l.FName LoopName,l.FStatus LoopStatus
		from
		<include refid="tableName"></include> f
		left join ZM_Loop l on f.Loop = l.Loop_ID
		where
		f.EQUIPMENT_ID = #{EQUIPMENT_ID}
	</select>

	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>,b.NAME FDeptName, d.NAME DictName,l.FName LoopName,l.FStatus LoopStatus,m.FNAME as WName
		<if test="pd.Month != null and pd.Month != ''">
			,case #{pd.Month} when  '1' then f.January when  '2' then f.February when  '3' then f.March when  '4' then f.April else f.May end energy
		</if>

		from
		<include refid="tableName"></include> f
		LEFT JOIN OA_DEPARTMENT b on f.FDept = b.DEPARTMENT_ID
		left join SYS_DICTIONARIES d on f.Files = d.DICTIONARIES_ID
		left join ZM_Loop l on f.Loop = l.Loop_ID
		left join MDM_AREA m on f.Workshop=m.AREA_ID
		where 1=1
		<if test="pd.KEYWORDS != null and pd.KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			f.FName LIKE '%'+ #{pd.KEYWORDS}+'%'
			OR
			FNumber LIKE '%'+ #{pd.KEYWORDS}+'%'
			)
		</if>
		<if test="pd.Files != null and pd.Files != ''"><!-- 关键词检索 -->
			and Files = #{pd.Files}
		</if>
		<if test="pd.FType != null and pd.FType != ''"><!-- 关键词检索 -->
			and f.FType = #{pd.FType}
		</if>
		<if test="pd.Workshop != null and pd.Workshop != ''"><!-- 关键词检索 -->
			and f.Workshop = #{pd.Workshop}
		</if>
		<if test="pd.faults != null and pd.faults != ''"><!-- 关键词检索 -->
			and
			f.alarmTime like '%'+#{pd.faults}+'%'
		</if>
		[fhstart]ORDER BY CreateTime DESC[fhend]
	</select>

	<!-- 列表 -->
	<select id="getByLoopdatalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>,b.NAME FDeptName, d.NAME DictName,l.FName LoopName,l.FStatus LoopStatus
		from
		<include refid="tableName"></include> f
		LEFT JOIN OA_DEPARTMENT b on f.FDept = b.DEPARTMENT_ID
		left join SYS_DICTIONARIES d on f.Files = d.DICTIONARIES_ID
		left join ZM_Loop l on f.Loop = l.Loop_ID
		where 1=1
		<if test="pd.loop != null and pd.loop != ''"><!-- 关键词检索 -->
			and Loop = #{pd.loop}
		</if>
		[fhstart]ORDER BY CreateTime DESC[fhend]
	</select>


	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>,b.NAME FDeptName, d.NAME DictName,l.FName LoopName,l.FStatus LoopStatus,l.Loop_ID LOOP_ID
		from
		<include refid="tableName"></include> f
		LEFT JOIN OA_DEPARTMENT b on f.FDept = b.DEPARTMENT_ID
		left join SYS_DICTIONARIES d on f.Files = d.DICTIONARIES_ID
		left join ZM_Loop l on f.Loop = l.Loop_ID
		where 1=1
		<if test="KEYWORDS != null and KEYWORDS != ''"><!-- 关键词检索 -->
			and
			(
			f.FName LIKE '%'+ #{KEYWORDS}+'%'
			OR
			f.FNumber LIKE '%'+ #{KEYWORDS}+'%'
			)
		</if>
		<if test="Files != null and Files != ''"><!-- 关键词检索 -->
			and f.Files = #{Files}
		</if>
		<if test="FName != null and FName != ''"><!-- 验重用 -->
			and f.FNumber = #{FName}
		</if>
		<if test="Workshop != null and Workshop != ''"><!-- 验重用 -->
			and f.Workshop = #{Workshop}
		</if>
		<if test="FType != null and FType != ''"><!-- 验重用 -->
			and f.FType = #{FType}
		</if>
		<if test="Location != null and Location != ''and Location != 'undefined'"><!-- 验重用 -->
			and f.Location LIKE '%'+ #{Location}+'%'
		</if>
		ORDER BY CreateTime DESC
	</select>

	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where
		EQUIPMENT_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
			#{item}
		</foreach>
	</delete>
	<select id="getCount" parameterType="pd" resultType="pd">
		SELECT '开启' as name ,COUNT(*) as value
		from ZM_Equipment f
		left join ZM_LOOP z ON f.Loop = z.LOOP_ID
		WHERE  z.FStatus=1
		<if test="FType != null and FType != ''and FType != 'undefined'"><!-- 验重用 -->
			and f.FType=#{FType}
		</if>
		<if test="Floor != null and Floor != ''and Floor != 'undefined'"><!-- 验重用 -->
			and f.Workshop=#{Floor}
		</if>
		UNION
		SELECT '关闭' as name ,COUNT(*) as value from ZM_Equipment f
		left join ZM_LOOP z ON f.Loop = z.LOOP_ID WHERE z.FStatus=0
		<if test="FType != null and FType != ''and FType != 'undefined'"><!-- 验重用 -->
			and f.FType=#{FType}
		</if>
		<if test="Floor != null and Floor != ''and Floor != 'undefined'"><!-- 验重用 -->
			and f.Workshop=#{Floor}
		</if>
	</select>
	<select id="getFailCount"  parameterType="pd" resultType="pd">
		SELECT '正常' as name ,COUNT(*) as value from ZM_Equipment f WHERE IfWarning='正常'
		<if test="FType != null and FType != ''and FType != 'undefined'"><!-- 验重用 -->
			and f.FType=#{FType}
		</if>
		<if test="Floor != null and Floor != ''and Floor != 'undefined'"><!-- 验重用 -->
			and f.Workshop=#{Floor}
		</if>
		UNION
		SELECT '故障' as name ,COUNT(*) as value from ZM_Equipment f WHERE IfWarning='故障'
		<if test="FType != null and FType != ''and FType != 'undefined'"><!-- 验重用 -->
			and f.FType=#{FType}
		</if>
		<if test="Floor != null and Floor != ''and Floor != 'undefined'"><!-- 验重用 -->
			and f.Workshop=#{Floor}
		</if>
	</select>
	<select id="getMonthList" resultType="pd" parameterType="pd">
		SELECT f.FTime, ISNULL(f1.FValue,'0') FValue
		from
			(
				SELECT '01' FTime union all
				SELECT '02' FTime union all
				SELECT '03' FTime union all
				SELECT '04' FTime union all
				SELECT '05' FTime union all
				SELECT '06' FTime union all
				SELECT '07' FTime union all
				SELECT '08' FTime union all
				SELECT '09' FTime union all
				SELECT '10' FTime union all
				SELECT '11' FTime union all
				SELECT '12' FTime
			) as f
				left join (
				select COUNT(*) as FValue,MONTH(ALARM_TIME) as FTime from ZM_ALARM GROUP BY MONTH(ALARM_TIME)
			) as f1 on f.FTime = f1.FTime
		ORDER BY
			FTime ASC

	</select>
	<!-- yy356703572qq(彬耶) -->
</mapper>