<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.yy.mapper.dsno1.zm.ALARMMapper">

	<!--表名 -->
	<sql id="tableName">
		ZM_ALARM
	</sql>

	<!--数据字典表名 -->
	<sql id="dicTableName">
		SYS_DICTIONARIES
	</sql>

	<!-- 字段 -->
	<sql id="Field">
		f
		.
		LOOP_ID
		,
		f.ALARM_CONTENT,
		f.ALARM_TIME,
		f.FCAUSE,
		f.EXPLAIN,
		f.IFHANDLE,
		f.FFILE,
		f.FFILENAME,
		f.HANDLENAME,
		f.HANDLETIME,
		f.PRIORITY,
		f.FType,
		f.ALARM_ID
	</sql>

	<!-- 字段用于新增 -->
	<sql id="Field2">
		LOOP_ID,
		ALARM_CONTENT,
		ALARM_TIME,
		IFHANDLE,
		PRIORITY,
		FType,
		ALARM_ID
	</sql>

	<!-- 字段值 -->
	<sql id="FieldValue">
		#{LOOP_ID},
		#{ALARM_CONTENT},
		#{ALARM_TIME},
		#{IFHANDLE},
		#{PRIORITY},
		#{FType},
		#{ALARM_ID}
	</sql>

	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into
		<include refid="tableName"></include>
		(
		<include refid="Field2"></include>
		) values (
		<include refid="FieldValue"></include>
		)
	</insert>

	<insert id="saveAll" parameterType="list">
		insert into
		<include refid="tableName"></include>
		(<include refid="Field2"></include>)
		VALUES
		<foreach collection="list" item="item" index="index" separator=",">
			(
			#{item.LOOP_ID},
			#{item.ALARM_CONTENT},
			#{item.ALARM_TIME},
			#{item.IFHANDLE},
			#{item.PRIORITY},
			#{item.FType},
			#{item.ALARM_ID}
			)
		</foreach>
	</insert>

	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where
		ALARM_ID = #{ALARM_ID}
	</delete>

	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set
		LOOP_ID = #{LOOP_ID},
		ALARM_CONTENT = #{ALARM_CONTENT},
		ALARM_TIME = #{ALARM_TIME},
		ALARM_ID = ALARM_ID
		where
		ALARM_ID = #{ALARM_ID}
	</update>

	<update id="handle" parameterType="pd">
		update
		<include refid="tableName"></include>
		set
		FCAUSE = #{FCAUSE},
		EXPLAIN = #{EXPLAIN},
		IFHANDLE = #{IFHANDLE},
		FFILE = #{FILE},
		FFILENAME = #{FFILENAME},
		HANDLENAME = #{HANDLENAME},
		HANDLETIME = #{HANDLETIME}
		where
		ALARM_ID = #{ALARM_ID}
	</update>

	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>,l.FName LOOP_NAME
		from
		<include refid="tableName"></include>
		f
		left JOIN ZM_Loop l on l.LOOP_ID=f.LOOP_ID
		where
		f.ALARM_ID = #{ALARM_ID}
	</select>

	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>,l.FName LOOP_NAME,n.FName NYLOOP_NAME
		from
		<include refid="tableName"></include>
		f
		left JOIN ZM_Loop l on l.LOOP_ID=f.LOOP_ID
		left JOIN NY_Loop n on n.LOOP_ID=f.LOOP_ID
		where 1=1
		<if test="pd.KEYWORDS1 != null and pd.KEYWORDS1 != ''"><!-- 关键词检索 -->
			and l.FName LIKE '%'+ #{pd.KEYWORDS1}+'%'
		</if>
		<if test="pd.startDate != null and pd.startDate != ''and pd.endDate != null and pd.endDate != ''"><!-- 关键词检索 -->
			and SUBSTRING(f.ALARM_TIME,0,11) &gt;= #{pd.startDate} and SUBSTRING(f.ALARM_TIME,0,11) &lt;= #{pd.endDate}
		</if>
		<if test="pd.PRIORITY != null and pd.PRIORITY != ''"><!-- 关键词检索 -->
			and f.PRIORITY = #{pd.PRIORITY}
		</if>
		[fhstart] ORDER BY ALARM_TIME DESC [fhend]
	</select>

	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>,l.FName LOOP_NAME
		from
		<include refid="tableName"></include>
		f
		left JOIN ZM_Loop l on l.LOOP_ID=f.LOOP_ID
		where 1=1
		<if test="KEYWORDS1 != null and KEYWORDS1 != '' and KEYWORDS1 != 'undefined'"><!-- 关键词检索 -->
			and l.FName LIKE '%'+ #{KEYWORDS1}+'%'
		</if>
		<if test="startDate != null and startDate != '' and startDate != 'undefined' and endDate != 'undefined'and endDate != null and endDate != ''"><!-- 关键词检索 -->
			and f.ALARM_TIME &gt;= #{startDate} and f.ALARM_TIME &lt;= #{endDate}
		</if>
		<if test="PRIORITY != null and PRIORITY != '' and PRIORITY != 'undefined'"><!-- 关键词检索 -->
			and f.PRIORITY = #{PRIORITY}
		</if>
	</select>

	<select id="listAllNoHandle" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>,l.FName LOOP_NAME
		from
		<include refid="tableName"></include>
		f
		left JOIN ZM_Loop l on l.LOOP_ID=f.LOOP_ID
		where IFHANDLE = '未处理'
	</select>

	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where
		ALARM_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
			#{item}
		</foreach>
	</delete>

	<select id="getAlarmMonth" resultType="pd">
		SELECT
		FMONTH.MONTH,
		ISNULL( DATA.ALARMCOUNT, 0 ) ALARMCOUNT
		FROM
		(
		SELECT CONVERT
		(
		VARCHAR ( 7 ),
		dateadd( mm, t.number, dateadd( YEAR, datediff( YEAR, 0, getdate( ) ), 0 ) ),
		120
		) MONTH
		FROM
		( SELECT number FROM master..spt_values WHERE type = 'P' AND number >= 0 AND number &lt;= 12 ) t
		WHERE
		YEAR ( dateadd( mm, t.number, dateadd( YEAR, datediff( YEAR, 0, getdate( ) ), 0 ) ) ) = YEAR ( getdate( ) )
		) FMONTH
		LEFT JOIN (
		SELECT COUNT
		( * ) ALARMCOUNT,
		SUBSTRING ( ALARM_TIME, 0, 8 ) ALARM_TIME
		FROM
		ZM_ALARM
		GROUP BY
		SUBSTRING ( ALARM_TIME, 0, 8 )
		) DATA ON FMONTH.MONTH = DATA.ALARM_TIME
		ORDER BY MONTH ASC
	</select>

	<!-- yy356703572qq(彬耶) -->
</mapper>